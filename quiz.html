<!DOCTYPE html>
<html>
	<head>
		<!--Code written by Shangzhen Yang-->
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,viewport-fit=cover">
		<meta name="theme-color" content="#0066cc">
		<link href="css/mui.min.css" rel="stylesheet">
		<link href="css/general.css" rel="stylesheet">
		<style>
			button,
			.answer,
			#OptionUl{
				margin-top:15px;
			}
			#AnswerUl{
				display:none;
			}
		</style>
	</head>
	<body>
		<header class="mui-bar mui-bar-nav title"></header>
		<div class="mui-content">
			<ul class="menu card">
				<li id="Show" class="menu"></li>
			</ul>
			<div class="answer">
				<div id="EnterWordDiv" class="mui-input-row">
					<label id="WordLabel"></label>
					<input id="EnteredWord" type="text">
				</div>
				<div id="EnterDefinitionDiv" class="mui-input-row">
					<label id="DefinitionLabel"></label>
					<input id="EnteredDefinition" type="text">
				</div>
				<ul id="AnswerUl" class="menu">
					<li id="Option1" class="menu"></li>
					<li id="Option2" class="menu"></li>
					<li id="Option3" class="menu"></li>
					<li id="Option4" class="menu"></li>
				</ul>
			</div>
			<button type="button" class="mui-btn mui-btn-blue mui-btn-block"></button>
			<ul id="OptionUl" class="menu">
				<li id="Restart" class="menu"></li>
				<li id="Speak" class="menu"></li>
				<li class="menu">
					<span id="MultipleChoice"></span>
					<div id="MultipleChoiceSwitch" class="mui-switch mui-switch-blue mui-switch-mini">
						<div class="mui-switch-handle"></div>
					</div>
				</li>
				<li id="SpeakWordsLi" class="menu">
					<span id="SpeakWords"></span>
					<div id="SpeakWordsSwitch" class="mui-switch mui-switch-blue mui-switch-mini">
						<div class="mui-switch-handle"></div>
					</div>
				</li>
				<li id="SpeakDefinitionsLi" class="menu">
					<span id="SpeakDefinitions"></span>
					<div id="SpeakDefinitionsSwitch" class="mui-switch mui-switch-blue mui-switch-mini">
						<div class="mui-switch-handle"></div>
					</div>
				</li>
				<li class="menu">
					<span id="EnterWords"></span>
					<div id="EnterWordsSwitch" class="mui-switch mui-switch-blue mui-switch-mini mui-active">
						<div class="mui-switch-handle"></div>
					</div>
				</li>
				<li class="menu">
					<span id="EnterDefinitions"></span>
					<div id="EnterDefinitionsSwitch" class="mui-switch mui-switch-blue mui-switch-mini">
						<div class="mui-switch-handle"></div>
					</div>
				</li>
				<li class="menu">
					<span id="ShowWords"></span>
					<div id="ShowWordsSwitch" class="mui-switch mui-switch-blue mui-switch-mini">
						<div class="mui-switch-handle"></div>
					</div>
				</li>
				<li class="menu">
					<span id="ShowDefinitions"></span>
					<div id="ShowDefinitionsSwitch" class="mui-switch mui-switch-blue mui-switch-mini mui-active">
						<div class="mui-switch-handle"></div>
					</div>
				</li>
			</ul>
		</div>
		<script src="cordova.js"></script>
		<script src="js/mui.min.js"></script>
		<script src="js/jquery.min.js"></script>
		<script src="js/general.js"></script>
		<script type="text/javascript">
			var correctDefinition,
			correctInt=0,
			correctWord,
			currentList,
			handle=document.getElementsByClassName("mui-switch-handle"),
			mistakes,
			openedWordList=localStorage.getItem("WordList"),
			outOfOrder=[],
			progress=1,
			settingsChanged,
			showAnswer=false,
			wordIndex
			function addMistake(word,definition){
				var repeat=false
				for(var i=0;i<mistakes.list.length;i++){
					if(mistakes.list[i].word==word){
						repeat=true
					}
				}
				if(!repeat){
					mistakes.list.push({
						"definition":definition,
						"word":word
					})
				}
			}
			function end(){
				var correctRate=Math.round(100-(mistakes.list.length/progress)*100)
				if(mistakes.list.length>0){
					localStorage.setItem("WordList",JSON.stringify(mistakes))
				}
				showAlert([
					"Correct rate: "+correctRate+"%",
					"正确率："+correctRate+"%"
				],mui.back)
			}
			function generateOrder(){
				wordIndex=Math.round(Math.random()*currentList.length-1)+1
				if(arrayContains(wordIndex,outOfOrder)||wordIndex==0){
					generateOrder()
				}
			}
			function loadQuestion(){
				showAnswer=false
				document.getElementById("EnteredWord").value=""
				document.getElementById("EnteredDefinition").value=""
				document.getElementsByClassName("mui-title")[0].innerText=document.title+" ("+progress+"/"+currentList.length+")"
				generateOrder()
				outOfOrder.push(wordIndex)
				correctWord=currentList[wordIndex-1].word
				correctDefinition=currentList[wordIndex-1].definition
				if(document.getElementById("MultipleChoiceSwitch").classList.contains("mui-active")){
					document.getElementById("Option1").innerText=
					document.getElementById("Option2").innerText=
					document.getElementById("Option3").innerText=
					document.getElementById("Option4").innerText=""
					var optionIndex=0,optionStr=""
					correctInt=Math.round(Math.random()*3)
					var options=[wordIndex]
					if(document.getElementById("EnterWordsSwitch").classList.contains("mui-active")){
						optionStr=correctWord
					}else if(document.getElementById("EnterDefinitionsSwitch").classList.contains("mui-active")){
						optionStr=correctDefinition
					}
					switch(correctInt){
						case 0:
						document.getElementById("Option1").innerText=optionStr
						break
						case 1:
						document.getElementById("Option2").innerText=optionStr
						break
						case 2:
						document.getElementById("Option3").innerText=optionStr
						break
						case 3:
						document.getElementById("Option4").innerText=optionStr
						break
						default:break
					}
					var generateOption=function(){
						optionIndex=Math.round(Math.random()*currentList.length-1)+1
						if(arrayContains(optionIndex,options)||optionStr==null||optionIndex==0){
							generateOption()
						}else{
							if(document.getElementById("EnterWordsSwitch").classList.contains("mui-active")){
								optionStr=currentList[optionIndex-1].word
							}else if(document.getElementById("EnterDefinitionsSwitch").classList.contains("mui-active")){
								optionStr=currentList[optionIndex-1].definition
							}
							options.push(optionIndex)
						}
					}
					for(var i=0;i<4;i++){
						generateOption()
						if(document.getElementById("Option1").innerText==""){
							document.getElementById("Option1").innerText=optionStr
						}else if(document.getElementById("Option2").innerText==""){
							document.getElementById("Option2").innerText=optionStr
						}else if(document.getElementById("Option3").innerText==""){
							document.getElementById("Option3").innerText=optionStr
						}else if(document.getElementById("Option4").innerText==""){
							document.getElementById("Option4").innerText=optionStr
						}
					}
				}
				if(document.getElementById("ShowWordsSwitch").classList.contains("mui-active")){
					document.getElementById("Show").innerText=correctWord
				}else if(document.getElementById("ShowDefinitionsSwitch").classList.contains("mui-active")){
					document.getElementById("Show").innerText=correctDefinition
				}else{
					switch(language){
						case "SimplifiedChinese":
						document.getElementById("Show").innerText="没有可显示的内容"
						break
						default:
						document.getElementById("Show").innerText="There is nothing to show"
						break
					}
				}
				speak()
			}
			function next(){
				if(settingsChanged){
					showAlert([
						"Click Restart to apply the settings",
						"单击重新开始使设置生效"
					])
				}else{
					if(!showAnswer&&document.getElementById("MultipleChoiceSwitch").classList.contains("mui-active")){
						addMistake(correctWord,correctDefinition)
					}
					if(!showAnswer&&!document.getElementById("MultipleChoiceSwitch").classList.contains("mui-active")){
						showAnswer=true
						if(document.getElementById("EnterWordsSwitch").classList.contains("mui-active")){
							if(document.getElementById("EnteredWord").value.replace(/(\s*$)/g,"").toLowerCase()==correctWord.toLowerCase()){
								switch(language){
									case "SimplifiedChinese":
									document.getElementById("EnteredWord").value+="（正确）"
									break
									default:
									document.getElementById("EnteredWord").value+=" (Correct)"
									break
								}
							}else{
								addMistake(correctWord,correctDefinition)
								switch(language){
									case "SimplifiedChinese":
									document.getElementById("EnteredWord").value+=" ≠ "+correctWord+"（错误）"
									break
									default:
									document.getElementById("EnteredWord").value+=" ≠ "+correctWord+" (Incorrect)"
									break
								}
							}
						}
						if(document.getElementById("EnterDefinitionsSwitch").classList.contains("mui-active")){
							var enteredDefWithoutSpace=document.getElementById("EnteredDefinition").value.replace(/\s+/g,""),
							correctDefWithoutSpace=correctDefinition.replace(/\s+/g,""),
							incorrect=function(){
								addMistake(correctWord,correctDefinition)
								switch(language){
									case "SimplifiedChinese":
									document.getElementById("EnteredDefinition").value+=" ≠ "+correctDefinition+"（错误）"
									break
									default:
									document.getElementById("EnteredDefinition").value+=" ≠ "+correctDefinition+" (Incorrect)"
									break
								}
							}
							if(enteredDefWithoutSpace==correctDefWithoutSpace){
								switch(language){
									case "SimplifiedChinese":
									document.getElementById("EnteredDefinition").value+="（正确）"
									break
									default:
									document.getElementById("EnteredDefinition").value+=" (Correct)"
									break
								}
							}else if(correctDefWithoutSpace.indexOf(enteredDefWithoutSpace)!=-1||enteredDefWithoutSpace.indexOf(correctDefWithoutSpace)!=-1){
								if(enteredDefWithoutSpace==""){
									incorrect()
								}else{
									var defCorrectRate
									if(correctDefinition.length>enteredDefWithoutSpace.length){
										defCorrectRate=(enteredDefWithoutSpace.length/correctDefinition.length)*100
									}else{
										defCorrectRate=(correctDefinition.length/enteredDefWithoutSpace.length)*100
									}
									if(defCorrectRate<1){
										defCorrectRate=1
									}else if(defCorrectRate>99){
										defCorrectRate=99
									}
									switch(language){
										case "SimplifiedChinese":
										document.getElementById("EnteredDefinition").value+=" ≈ "+correctDefinition+"（"+defCorrectRate+"% 正确）"
										break
										default:
										document.getElementById("EnteredDefinition").value+=" ≈ "+correctDefinition+" ("+defCorrectRate+"% Correct)"
										break
									}
								}
							}else{
								incorrect()
							}
						}
					}else{
						if(progress>=currentList.length){
							end()
						}else{
							progress+=1
							loadQuestion()
						}
					}
				}
			}
			function optionClicked(clickedNum){
				if(document.getElementById("MultipleChoiceSwitch").classList.contains("mui-active")){
					if(clickedNum==correctInt){
						showAnswer=true
						next()
					}else{
						addMistake(correctWord,correctDefinition)
						showAlert([
							"Not this one",
							"不是这个"
						])
					}
				}
			}
			function restart(){
				settingsChanged=false
				progress=1
				outOfOrder=[]
				mistakes.list=[]
				loadQuestion()
				if(document.getElementById("MultipleChoiceSwitch").classList.contains("mui-active")){
					document.getElementById("AnswerUl").style.display="block"
					document.getElementById("EnterWordDiv").style.display="none"
					document.getElementById("EnterDefinitionDiv").style.display="none"
				}else{
					document.getElementById("AnswerUl").style.display=""
					if(document.getElementById("EnterWordsSwitch").classList.contains("mui-active")&&document.getElementById("EnterDefinitionsSwitch").classList.contains("mui-active")){
						document.getElementById("EnterWordDiv").style.display=""
						document.getElementById("EnterDefinitionDiv").style.display=""
					}else if(document.getElementById("EnterWordsSwitch").classList.contains("mui-active")&&!document.getElementById("EnterDefinitionsSwitch").classList.contains("mui-active")){
						document.getElementById("EnterWordDiv").style.display=""
						document.getElementById("EnterDefinitionDiv").style.display="none"
					}else if(!document.getElementById("EnterWordsSwitch").classList.contains("mui-active")&&document.getElementById("EnterDefinitionsSwitch").classList.contains("mui-active")){
						document.getElementById("EnterWordDiv").style.display="none"
						document.getElementById("EnterDefinitionDiv").style.display=""
					}else{
						document.getElementById("EnterWordDiv").style.display="none"
						document.getElementById("EnterDefinitionDiv").style.display="none"
					}
				}
				document.getElementsByTagName("button")[0].style.display=""
			}
			function speak(){
				if(window.speechSynthesis){
					var speakText=""
					if(document.getElementById("SpeakWordsSwitch").classList.contains("mui-active")){
						speakText+=correctWord+". "
					}
					if(document.getElementById("SpeakDefinitionsSwitch").classList.contains("mui-active")){
						speakText+=correctDefinition+". "
					}
					window.speechSynthesis.speak(new SpeechSynthesisUtterance(speakText))
				}
			}
			window.onkeydown=function(e){
				switch(e.keyCode){
					case 49:
					optionClicked(0)
					break
					case 50:
					optionClicked(1)
					break
					case 51:
					optionClicked(2)
					break
					case 52:
					optionClicked(3)
					break
					default:break
				}
			}
			document.getElementsByClassName("back")[0].onclick=end
			document.getElementById("EnteredWord").onkeydown=function(e){
				if(e.keyCode==13&&this.value!=""){
					if(document.getElementById("EnterDefinitionsSwitch").classList.contains("mui-active")){
						document.getElementById("EnteredDefinition").focus()
					}else{
						next()
					}
				}
			}
			document.getElementById("EnteredDefinition").onkeydown=function(e){
				if(e.keyCode==13&&this.value!=""){
					next()
					if(!showAnswer&&document.getElementById("EnterWordsSwitch").classList.contains("mui-active")){
						document.getElementById("EnteredWord").focus()
					}
				}
			}
			document.getElementById("Option1").onclick=function(){
				optionClicked(0)
			}
			document.getElementById("Option2").onclick=function(){
				optionClicked(1)
			}
			document.getElementById("Option3").onclick=function(){
				optionClicked(2)
			}
			document.getElementById("Option4").onclick=function(){
				optionClicked(3)
			}
			document.getElementsByTagName("button")[0].onclick=next
			document.getElementById("Restart").onclick=restart
			document.getElementById("Speak").onclick=speak
			for(var i=0;i<handle.length;i++){
				handle[i].onclick=function(){
					settingsChanged=true
				}
			}
			switch(language){
				case "SimplifiedChinese":
				document.title="测验"
				document.getElementById("WordLabel").innerText="单词"
				document.getElementById("EnteredWord").placeholder="在这里输入"
				document.getElementById("DefinitionLabel").innerText="释义"
				document.getElementById("EnteredDefinition").placeholder="在这里输入"
				document.getElementsByTagName("button")[0].innerText="下一题"
				document.getElementById("Restart").innerText="重新开始"
				document.getElementById("Speak").innerText="朗读"
				document.getElementById("MultipleChoice").innerText="选择题"
				document.getElementById("SpeakWords").innerText="朗读单词"
				document.getElementById("SpeakDefinitions").innerText="朗读释义"
				document.getElementById("EnterWords").innerText="输入单词"
				document.getElementById("EnterDefinitions").innerText="输入释义"
				document.getElementById("ShowWords").innerText="显示单词"
				document.getElementById("ShowDefinitions").innerText="显示释义"
				mistakes={
					"list":[],
					"title":"错题"
				}
				break
				default:
				document.title="Quiz"
				document.getElementById("WordLabel").innerText="Word"
				document.getElementById("EnteredWord").placeholder="Enter here"
				document.getElementById("DefinitionLabel").innerText="Definition"
				document.getElementById("EnteredDefinition").placeholder="Enter here"
				document.getElementsByTagName("button")[0].innerText="Next"
				document.getElementById("Restart").innerText="Restart"
				document.getElementById("Speak").innerText="Speak"
				document.getElementById("MultipleChoice").innerText="Multiple Choice"
				document.getElementById("SpeakWords").innerText="Speak Words"
				document.getElementById("SpeakDefinitions").innerText="Speak Definitions"
				document.getElementById("EnterWords").innerText="Enter Words"
				document.getElementById("EnterDefinitions").innerText="Enter Definitions"
				document.getElementById("ShowWords").innerText="Show Words"
				document.getElementById("ShowDefinitions").innerText="Show Definitions"
				mistakes={
					"list":[],
					"title":"Mistakes"
				}
				break
			}
			if(!window.speechSynthesis){
				document.getElementById("Speak").style.display="none"
				document.getElementById("SpeakWordsLi").style.display="none"
				document.getElementById("SpeakDefinitionsLi").style.display="none"
			}
			if(openedWordList){
				currentList=JSON.parse(openedWordList).list
			}
			restart()
		</script>
	</body>
</html>
