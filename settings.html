<!DOCTYPE html>
<html>
	<head>
		<!--Code written by Shangzhen Yang-->
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,viewport-fit=cover">
		<meta name="theme-color" content="#0066cc">
		<link href="css/mui.min.css" rel="stylesheet">
		<link href="css/general.css" rel="stylesheet">
		<style>
			footer div{
				width:100%;
			}
			p{
				padding:0px 5px;
			}
			p:last-of-type{
				margin:10px 0px 55px 0px;
			}
			#MyAccount{
				display:none;
			}
		</style>
	</head>
	<body>
		<header class="mui-bar mui-bar-nav title"></header>
		<div class="mui-content">
			<table width="100%">
				<tbody>
					<tr>
						<td width="30%">
							<div id="Language"></div>
						</td>
						<td width="70%">
							<select id="LanguageSelect">
								<option value="SimplifiedChinese">简体中文</option>
								<option value="English">English</option>
							</select>
						</td>
					</tr>
					<tr>
						<td width="30%">
							<div id="Theme"></div>
						</td>
						<td width="70%">
							<select id="ThemeSelect"></select>
						</td>
					</tr>
				</tbody>
			</table>
			<p id="MyEmail"></p>
			<ul class="menu">
				<li id="Login" class="menu"></li>
				<span id="MyAccount">
					<li id="ChangePassword" class="menu"></li>
					<li id="ChangeEmail" class="menu"></li>
					<li id="DeleteAccount" class="menu"></li>
					<li id="LogOut" class="menu"></li>
				</span>
				<li id="ClearLocalStorage" class="menu"></li>
			</ul>
			<p id="Introduction"></p>
		</div>
		<footer>
			<div id="About"></div>
		</footer>
		<script src="cordova.js"></script>
		<script src="js/mui.min.js"></script>
		<script src="js/jquery.min.js"></script>
		<script src="js/md5.min.js"></script>
		<script src="js/general.js"></script>
		<script type="text/javascript">
			document.getElementById("LanguageSelect").onchange=function(){
				if(this.value!=language){
					localStorage.setItem("Language",document.getElementById("LanguageSelect").value)
					restart()
				}
			}
			document.getElementById("ThemeSelect").onchange=function(){
				if(this.value!=theme){
					localStorage.setItem("Theme",document.getElementById("ThemeSelect").value)
					restart()
				}
			}
			document.getElementById("Login").onclick=loginDialog
			document.getElementById("ChangePassword").onclick=function(){
				showPrompt([
					"Enter your current password",
					"输入您的当前密码"
				],function(e){
					$.get("https://api.rthsoftware.cn/userdata/verify.php",{
						"email":login.email,
						"password":MD5(e),
						"time":new Date().getTime()
					},function(verifyResult){
						if(verifyResult.pass){
							showPrompt([
								"Enter a new password",
								"输入新密码"
							],function(newPassword){
								showPrompt([
									"Enter the new password again",
									"再次输入新密码"
								],function(confirmPassword){
									if(confirmPassword==newPassword){
										localStorage.setItem("Password",MD5(newPassword))
										$.post("https://api.rthsoftware.cn/reset.php",{
											"index":verifyResult.index,
											"passwordmd5":MD5(newPassword)
										},function(){
											showAlert([
												"The password is changed",
												"密码已更改"
											],function(){
												location.reload()
											})
										})
									}else{
										showAlert([
											"The two passwords you entered are inconsistent",
											"两次输入的密码不一致"
										])
									}
								},"password")
							},"password")
						}else{
							showAlert([
								"Incorrect password",
								"密码错误"
							])
						}
					},"json")
				},"password")
			}
			document.getElementById("ChangeEmail").onclick=function(){
				showPrompt([
					"Enter your current password",
					"输入您的当前密码"
				],function(e){
					$.get("https://api.rthsoftware.cn/userdata/verify.php",{
						"email":login.email,
						"password":MD5(e),
						"time":new Date().getTime()
					},function(verifyResult){
						if(verifyResult.pass){
							showPrompt([
								"Enter the new email address",
								"输入新电子邮箱地址"
							],function(newEmail){
								$.get("https://api.rthsoftware.cn/userdata/verify.php",{
									"email":newEmail,
									"password":login.password,
									"time":new Date().getTime()
								},function(newVerify){
									if(newVerify.index>0){
										showAlert([
											"This email address has already been occupied",
											"此电子邮箱地址已被占用"
										])
									}else{
										showPrompt([
											"Enter the new email address again",
											"再次输入新电子邮箱地址"
										],function(confirmEmail){
											if(confirmEmail==newEmail){
												localStorage.setItem("Email",newEmail)
												$.post("https://api.rthsoftware.cn/reset.php",{
													"index":verifyResult.index,
													"newemail":newEmail
												},function(){
													showAlert([
														"The email address is changed",
														"电子邮箱地址已更改"
													],function(){
														location.reload()
													})
												})
											}else{
												showAlert([
													"The two email addresses you entered are inconsistent",
													"两次输入的电子邮箱地址不一致"
												])
											}
										},"email")
									}
								},"json")
							},"email")
						}else{
							showAlert([
								"Incorrect password",
								"密码错误"
							])
						}
					},"json")
				},"password")
			}
			document.getElementById("DeleteAccount").onclick=function(){
				showConfirm([
					"This will delete all your data on the server",
					"此操作将在服务器上删除您的所有数据"
				],function(){
					showPrompt([
						"Enter your current password",
						"输入您的当前密码"
					],function(e){
						$.get("https://api.rthsoftware.cn/userdata/verify.php",{
							"email":login.email,
							"password":MD5(e),
							"time":new Date().getTime()
						},function(verifyResult){
							if(verifyResult.pass){
								$.post("https://api.rthsoftware.cn/userdata/remove.php",{
									"index":verifyResult.index,
									"username":login.username
								},logOut)
							}else{
								showAlert([
									"Incorrect password",
									"密码错误"
								])
							}
						},"json")
					},"password")
				})
			}
			document.getElementById("LogOut").onclick=logOut
			document.getElementById("ClearLocalStorage").onclick=function(){
				showConfirm([
					"Do you want to clear the local storage?",
					"您想清空本地存储吗？"
				],function(){
					localStorage.clear()
					restart()
				})
			}
			document.getElementById("About").onclick=function(){
				openWindow("about")
			}
			switch(language){
				case "SimplifiedChinese":
				document.title="设置"
				document.getElementById("Language").innerText="语言"
				document.getElementById("Theme").innerText="主题"
				document.getElementById("ThemeSelect").options.add(new Option("自动","Automatic"))
				document.getElementById("ThemeSelect").options.add(new Option("必应","Bing"))
				document.getElementById("ThemeSelect").options.add(new Option("浅色","Light"))
				document.getElementById("ThemeSelect").options.add(new Option("深色","Dark"))
				document.getElementById("MyEmail").innerText="未登录"
				document.getElementById("Login").innerText="登录"
				document.getElementById("ChangePassword").innerText="更改密码"
				document.getElementById("ChangeEmail").innerText="更改电子邮箱"
				document.getElementById("DeleteAccount").innerText="删除账号"
				document.getElementById("LogOut").innerText="退出登录"
				document.getElementById("ClearLocalStorage").innerText="清空本地存储"
				document.getElementById("Introduction").innerText="登录后，您可以在 https://toolbox.rthsoftware.cn/ 查看您保存的单词表和文本文档。"
				document.getElementById("About").innerText="关于 RTH 工具箱"
				break
				default:
				document.title="Settings"
				document.getElementById("Language").innerText="Language"
				document.getElementById("Theme").innerText="Theme"
				document.getElementById("ThemeSelect").options.add(new Option("Automatic","Automatic"))
				document.getElementById("ThemeSelect").options.add(new Option("Bing","Bing"))
				document.getElementById("ThemeSelect").options.add(new Option("Light","Light"))
				document.getElementById("ThemeSelect").options.add(new Option("Dark","Dark"))
				document.getElementById("MyEmail").innerText="Not logged in"
				document.getElementById("Login").innerText="Login"
				document.getElementById("ChangePassword").innerText="Change Password"
				document.getElementById("ChangeEmail").innerText="Change Email"
				document.getElementById("DeleteAccount").innerText="Delete Account"
				document.getElementById("LogOut").innerText="Log Out"
				document.getElementById("ClearLocalStorage").innerText="Clear Local Storage"
				document.getElementById("Introduction").innerText="After logging in, you can view your saved word lists and text documents at https://toolbox.rthsoftware.cn/."
				document.getElementById("About").innerText="About RTH Toolbox"
				break
			}
			document.getElementsByClassName("mui-title")[0].innerText=document.title
			document.getElementById("LanguageSelect").value=language
			document.getElementById("ThemeSelect").value=theme
			if(login.username){
				document.getElementById("MyEmail").innerText=login.email
				document.getElementById("Login").style.display="none"
				document.getElementById("MyAccount").style.display="block"
				document.getElementById("Introduction").innerText=document.getElementById("Introduction").innerText.
				replace("After logging in, y","Y").
				replace("登录后，","")
			}
		</script>
	</body>
</html>
