<!DOCTYPE html>
<html>
	<head>
		<!--Code written by Shangzhen Yang-->
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,viewport-fit=cover">
		<meta name="theme-color" content="#0066cc">
		<link href="css/mui.min.css" rel="stylesheet">
		<link href="css/general.css" rel="stylesheet">
		<style>
			button,
			fieldset{
				margin-top:20px;
			}
			.number{
				font-size:45px;
				line-height:60px;
				text-align:center;
			}
		</style>
	</head>
	<body>
		<header class="mui-bar mui-bar-nav title"></header>
		<div class="mui-content">
			<div class="number">0</div>
			<div class="btn-bg-img">
				<button type="button" class="mui-btn mui-btn-blue mui-btn-block"></button>
			</div>
			<fieldset>
				<legend id="Settings"></legend>
				<div class="width-limit">
					<div class="input-bg">
						<div class="mui-input-row">
							<label id="QuantityLabel"></label>
							<input id="Quantity" type="text" value="1">
						</div>
						<div class="mui-input-row">
							<label id="MinimumLabel"></label>
							<input id="Minimum" type="text" value="1">
						</div>
						<div class="mui-input-row">
							<label id="MaximumLabel"></label>
							<input id="Maximum" type="text" value="60">
						</div>
					</div>
					<div class="mui-input-row mui-checkbox">
						<label id="DuplicatesLabel"></label>
						<input id="DuplicatesCheck" type="checkbox" checked="checked">
					</div>
					<div class="mui-input-row mui-checkbox">
						<label id="OddNumberOnlyLabel"></label>
						<input id="OddNumberOnlyCheck" type="checkbox">
					</div>
					<div class="mui-input-row mui-checkbox">
						<label id="EvenNumberOnlyLabel"></label>
						<input id="EvenNumberOnlyCheck" type="checkbox">
					</div>
					<div class="mui-input-row mui-checkbox">
						<label id="ShowMoreLabel"></label>
						<input id="ShowMoreCheck" type="checkbox" checked="checked">
					</div>
				</div>
			</fieldset>
			<fieldset>
				<legend id="History"></legend>
				<ul class="menu">
					<li id="Add" class="menu"></li>
					<li id="Clear" class="menu"></li>
				</ul>
				<ul id="HistoryUl" class="menu text-like"></ul>
			</fieldset>
			<fieldset>
				<legend id="Names" class="menu"></legend>
				<ul class="menu">
					<li id="NamesSave" class="menu"></li>
					<li id="NamesAdd" class="menu"></li>
					<li id="NamesClear" class="menu"></li>
				</ul>
				<ul id="NamesUl" class="menu text-like"></ul>
			</fieldset>
		</div>
		<script src="cordova.js"></script>
		<script src="js/mui.min.js"></script>
		<script src="js/jquery.min.js"></script>
		<script src="js/md5.min.js"></script>
		<script src="js/general.js"></script>
		<script type="text/javascript">
			var historyArray=[],
			intervalId,
			nameValue="",
			randomNumValue,
			savedNames,
			scrolling=true
			function add(){
				document.getElementById("HistoryUl").innerHTML=""
				historyArray.push({
					"name":nameValue,
					"number":randomNumValue
				})
				for(var i=historyArray.length-1;i>=0;i--){
					var newLi=document.createElement("li")
					newLi.classList.add("menu")
					if(historyArray[i].name!=""){
						newLi.innerText="("+(i+1)+") "+historyArray[i].name
					}else{
						newLi.innerText="("+(i+1)+") "+historyArray[i].number
					}
					document.getElementById("HistoryUl").appendChild(newLi)
				}
			}
			function addName(){
				if(localStorage.getItem("Username")){
					showPrompt([
						"Enter a person's name",
						"输入一个人的名字"
					],function(e){
						savedNames.names.push(e)
						loadNames(savedNames.names.length-1)
						count()
						addName()
					})
				}else{
					loginDialog()
				}
			}
			function clearHistory(negativeCallback){
				if(document.getElementById("HistoryUl").innerHTML!=""){
					showConfirm([
						"Do you want to clear the history?",
						"您想清空历史记录吗？"
					],function(){
						document.getElementById("HistoryUl").innerHTML=""
						historyArray=[]
					},negativeCallback)
				}
			}
			function count(){
				if(savedNames.names.length<=0){
					document.getElementById("Minimum").value="1"
					document.getElementById("Maximum").value="60"
				}else{
					document.getElementById("Minimum").value="1"
					document.getElementById("Maximum").value=savedNames.names.length
				}
			}
			function load(){
				document.getElementById("NamesUl").innerHTML=""
				for(var i=0;i<savedNames.names.length;i++){
					loadNames(i)
				}
				count()
			}
			function loadNames(i){
				var newLi=document.createElement("li")
				newLi.classList.add("menu")
				newLi.innerText=savedNames.names[i]
				newLi.setAttribute("number",i+1)
				newLi.oncontextmenu=
				newLi.onclick=function(mouse){
					var index=this.getAttribute("number")*1-1
					showMenu(mouse,[{
						"onclick":function(){
							showPrompt([
								"Change "+savedNames.names[index]+" to",
								"把"+savedNames.names[index]+"更改为"
							],function(newName){
								savedNames.names[index]=newName
								submit()
							},null,savedNames.names[index])
							closeMenu()
						},
						"text":[
							"Change",
							"更改"
						]
					},{
						"onclick":function(){
							showConfirm([
								"Do you want to delete "+savedNames.names[index]+"?",
								"您想删除"+savedNames.names[index]+"吗？"
							],function(){
								savedNames.names.splice(index,1)
								submit()
							})
							closeMenu()
						},
						"text":[
							"Delete",
							"删除"
						]
					}])
				}
				document.getElementById("NamesUl").appendChild(newLi)
			}
			function random(){
				var hide=false,
				min=parseInt(document.getElementById("Minimum").value),
				max=parseInt(document.getElementById("Maximum").value),
				total
				nameValue=""
				randomNumValue=min+Math.round(Math.random()*(max-min))
				if(savedNames.names.length>0){
					nameValue=savedNames.names[randomNumValue-1]
				}
				if((function(){
					if(document.getElementById("OddNumberOnlyCheck").checked&randomNumValue%2==0||document.getElementById("EvenNumberOnlyCheck").checked&&randomNumValue%2!=0){
						return true
					}else if(historyArray.length>0&&!document.getElementById("DuplicatesCheck").checked){
						if(savedNames.names.length>0){
							total=savedNames.names.length
						}else{
							total=max-min+1
						}
						if(historyArray.length<total){
							if(historyArray.length-total==-1){
								hide=true
							}
							var contain=false
							for(var i=0;i<historyArray.length;i++){
								if(historyArray[i].number==randomNumValue){
									contain=true
								}
							}
							return contain
						}else if(historyArray.length>=total){
							document.getElementById("Add").style.display=""
							document.getElementById("DuplicatesCheck").checked=true
							return true
						}else{
							return false
						}
					}else{
						return false
					}
				})()){
					random()
				}else{
					if(hide&&scrolling){
						document.getElementsByClassName("number")[0].innerText="?"
					}else{
						if(nameValue!=""){
							document.getElementsByClassName("number")[0].innerText=nameValue
							return nameValue
						}else{
							document.getElementsByClassName("number")[0].innerText=randomNumValue
							return randomNumValue
						}
					}
				}
			}
			function randScroll(){
				random()
				scrolling=true
			}
			function submit(){
				savedNames.time=new Date().getTime()
				localStorage.setItem("Names",JSON.stringify(savedNames))
				if(login.username){
					showToast([
						"Submitting",
						"正在提交"
					])
					$.post(backend+"userdata/upload.php",{
						"dir":"names/",
						"filename":login.username,
						"text":JSON.stringify(savedNames)
					},function(){
						load()
						showToast([
							"Changes are saved",
							"更改已保存"
						])
					})
				}else{
					showToast([
						"Changes are saved",
						"更改已保存"
					])
					load()
				}
			}
			document.getElementsByTagName("button")[0].onclick=function(){
				var closeDialog=function(){
					if(document.getElementsByClassName("popup")[0]){
						document.getElementsByClassName("popup")[0].style.transform="scale(0)"
						setTimeout(function(){
							try{
								document.body.removeChild(document.getElementsByClassName("popup")[0])
							}catch(e){}
						},250)
					}
				},
				startScrolling=function(){
					intervalId=setInterval(randScroll,10)
					scrolling=true
				}
				closeDialog()
				if(scrolling==false){
					startScrolling()
				}else{
					clearInterval(intervalId)
					scrolling=false
					if(document.getElementsByClassName("number")[0].innerText=="?"){
						random()
					}
					var newDiv=document.createElement("div"),
					newH1=document.createElement("h1"),
					newNumDiv=document.createElement("div"),
					newButton=document.createElement("button"),
					quantity=parseInt(document.getElementById("Quantity").value)
					if(quantity<1||!quantity){
						document.getElementById("Quantity").value=quantity=1
					}else if(quantity>40){
						document.getElementById("Quantity").value=quantity=40
					}
					newDiv.classList.add("popup")
					newDiv.style.opacity="1"
					newDiv.style.transform="scale(0)"
					newNumDiv.classList.add("number")
					newButton.style.width="100%"
					newButton.onclick=function(){
						add()
						closeDialog()
						startScrolling()
					}
					for(var i=0;i<quantity;i++){
						if(newNumDiv.innerText){
							newNumDiv.innerText+=" "
							add()
							random()
						}
						newNumDiv.innerText+=document.getElementsByClassName("number")[0].innerText
					}
					switch(language){
						case "SimplifiedChinese":
						newH1.innerText="结果"
						newButton.innerText="添加到历史记录"
						break
						default:
						newH1.innerText="Result"
						newButton.innerText="Add to History"
					}
					newDiv.appendChild(newH1)
					newDiv.appendChild(newNumDiv)
					newDiv.appendChild(newButton)
					if(document.getElementById("DuplicatesCheck").checked&&quantity==1){
						var newCloseDiv=document.createElement("div")
						newCloseDiv.classList.add("close")
						newCloseDiv.innerText="×"
						newCloseDiv.onclick=function(){
							closeDialog()
							startScrolling()
						}
						newDiv.appendChild(newCloseDiv)
					}
					document.body.appendChild(newDiv)
					newDiv.style.top="calc(50% - "+(newDiv.offsetHeight/2)+"px)"
					setTimeout(function(){
						newDiv.style.transform=""
					},25)
				}
			}
			document.getElementById("DuplicatesCheck").onchange=function(){
				if(this.checked){
					document.getElementById("Add").style.display=""
				}else{
					document.getElementById("Add").style.display="none"
					clearHistory(function(){
						document.getElementById("Add").style.display=""
						document.getElementById("DuplicatesCheck").checked=true
					})
				}
			}
			document.getElementById("OddNumberOnlyCheck").onchange=function(){
				document.getElementById("EvenNumberOnlyCheck").checked=false
			}
			document.getElementById("EvenNumberOnlyCheck").onchange=function(){
				document.getElementById("OddNumberOnlyCheck").checked=false
			}
			document.getElementById("ShowMoreCheck").onchange=function(){
				var fieldset=document.getElementsByTagName("fieldset")
				if(this.checked){
					for(var i=1;i<fieldset.length;i++){
						fieldset[i].style.display=""
					}
				}else{
					for(var i=1;i<fieldset.length;i++){
						fieldset[i].style.display="none"
					}
				}
			}
			document.getElementById("Add").onclick=add
			document.getElementById("Clear").onclick=function(){
				clearHistory()
			}
			document.getElementById("NamesSave").onclick=submit
			document.getElementById("NamesAdd").onclick=addName
			document.getElementById("NamesClear").onclick=function(){
				showConfirm([
					"Do you want to clear the names?",
					"您想清空名字吗？"
				],function(){
					document.getElementById("NamesUl").innerHTML=""
					savedNames.names=[]
					submit()
				})
			}
			switch(language){
				case "SimplifiedChinese":
				document.title="随机抽号"
				document.getElementsByTagName("button")[0].innerText="立即抽号"
				document.getElementById("Settings").innerText="设置"
				document.getElementById("QuantityLabel").innerText="数量"
				document.getElementById("MinimumLabel").innerText="最小值"
				document.getElementById("MaximumLabel").innerText="最大值"
				document.getElementById("DuplicatesLabel").innerText="重复"
				document.getElementById("OddNumberOnlyLabel").innerText="仅奇数"
				document.getElementById("EvenNumberOnlyLabel").innerText="仅偶数"
				document.getElementById("ShowMoreLabel").innerText="显示更多"
				document.getElementById("History").innerText="历史记录"
				document.getElementById("Add").innerText="添加"
				document.getElementById("Clear").innerText="清空"
				document.getElementById("Names").innerText="名字"
				document.getElementById("NamesSave").innerText="保存"
				document.getElementById("NamesAdd").innerText="添加"
				document.getElementById("NamesClear").innerText="清空"
				break
				default:
				document.title="Random Number"
				document.getElementsByTagName("button")[0].innerText="Select Randomly"
				document.getElementById("Settings").innerText="Settings"
				document.getElementById("QuantityLabel").innerText="Quantity"
				document.getElementById("MinimumLabel").innerText="Minimum"
				document.getElementById("MaximumLabel").innerText="Maximum"
				document.getElementById("DuplicatesLabel").innerText="Duplicates"
				document.getElementById("OddNumberOnlyLabel").innerText="Odd Number Only"
				document.getElementById("EvenNumberOnlyLabel").innerText="Even Number Only"
				document.getElementById("ShowMoreLabel").innerText="Show More"
				document.getElementById("History").innerText="History"
				document.getElementById("Add").innerText="Add"
				document.getElementById("Clear").innerText="Clear"
				document.getElementById("Names").innerText="Names"
				document.getElementById("NamesSave").innerText="Save"
				document.getElementById("NamesAdd").innerText="Add"
				document.getElementById("NamesClear").innerText="Clear"
			}
			document.getElementsByClassName("mui-title")[0].innerText=document.title
			var currentNamesValue=localStorage.getItem("Names")
			if(currentNamesValue&&currentNamesValue.indexOf("{")!=-1){
				savedNames=JSON.parse(currentNamesValue)
			}else{
				savedNames={
					"names":[],
					"time":new Date().getTime()
				}
				if(currentNamesValue&&currentNamesValue.indexOf("\n")!=-1){
					var namesSplit=currentNamesValue.split("\n")
					for(var i=0;i<namesSplit.length;i++){
						if(namesSplit[i]!=""){
							savedNames.names.push(namesSplit[i])
						}
					}
				}
				localStorage.setItem("Names",JSON.stringify(savedNames))
			}
			load()
			if(login.username){
				getJSON("userdata/names/"+login.username+".txt",function(e){
					if(e.time>savedNames.time){
						savedNames=e
					}
					if(JSON.stringify(savedNames)!=JSON.stringify(e)&&savedNames.names.length>0){
						submit()
					}else if(savedNames.names.length<=0){
						savedNames=e
						load()
					}else{
						load()
					}
				},load)
			}
			intervalId=setInterval(function(){
				randScroll()
			},10)
		</script>
	</body>
</html>
