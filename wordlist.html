<!DOCTYPE html>
<html>
	<head>
		<!--Code written by Shangzhen Yang-->
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,viewport-fit=cover">
		<meta name="theme-color" content="#0066cc">
		<link href="css/mui.min.css" rel="stylesheet">
		<link href="css/general.css" rel="stylesheet">
		<style>
			footer{
				display:none;
			}
			footer div{
				width:50%;
			}
			ul.menu{
				margin-top:15px
			}
			.edit{
				display:none;
				margin-bottom:60px;
			}
			#OptionUl{
				margin-top:0px;
			}
		</style>
	</head>
	<body>
		<header class="mui-bar mui-bar-nav title"></header>
		<div class="mui-content">
			<div class="start">
				<div class="mui-input-row">
					<input id="LookUpInput" type="text" class="mui-input-clear">
				</div>
				<button type="button" class="mui-btn mui-btn-blue mui-btn-block"></button>
				<ul class="menu">
					<li id="NewWL" class="menu"></li>
					<li id="OpenLWL" class="menu"></li>
					<li id="SharingSettings" class="menu"></li>
					<span id="SavedWordListUl"></span>
				</ul>
			</div>
			<div class="edit">
				<div class="mui-input-row">
					<input id="TitleInput" type="text" class="mui-input-clear">
				</div>
				<ul id="OptionUl" class="menu">
					<li id="Quiz" class="menu"></li>
					<li id="SaveAs" class="menu"></li>
					<li id="Delete" class="menu"></li>
					<li id="FlashCard" class="menu"></li>
				</ul>
				<ul id="WordListUl" class="menu"></ul>
			</div>
		</div>
		<footer>
			<div id="Save"></div>
			<div id="Add"></div>
		</footer>
		<input class="open-file" type="file" accept=".rth">
		<script src="cordova.js"></script>
		<script src="js/mui.min.js"></script>
		<script src="js/jquery.min.js"></script>
		<script src="js/md5.min.js"></script>
		<script src="js/general.js"></script>
		<script type="text/javascript">
			var adminWordList,
			currentItem,
			currentList=[],
			friendWordList,
			savedWordList
			function add(){
				showPrompt([
					"Enter a new word",
					"输入新单词"
				],function(newWord){
					showPrompt([
						"Enter the definition of the new word",
						"输入新单词的释义"
					],function(newDefinition){
						addWord(newWord,newDefinition)
					},null,null,function(){
						var wordWithoutSpace=newWord.replace(/\s/g,"").toLowerCase()
						if(localStorage.getItem(wordWithoutSpace+"_CNDef")!=null){
							var CNDef=localStorage.getItem(wordWithoutSpace+"_CNDef"),
							ENDef=localStorage.getItem(wordWithoutSpace+"_ENDef")
							if(language=="SimplifiedChinese"&&CNDef!=null){
								addWord(newWord,CNDef)
							}else if(ENDef!=null){
								addWord(newWord,ENDef)
							}
						}else{
							$.ajax({
								"url":"https://rthsoftware.azurewebsites.net/shanbay.php",
								"data":{
									"word":newWord
								},
								"dataType":"json",
								"success":function(e){
									if(e.msg=="SUCCESS"){
										if(language=="SimplifiedChinese"&&e.data.cn_definition.defn!=null){
											addWord(newWord,e.data.cn_definition.defn)
										}else if(e.data.en_definition.defn!=null){
											addWord(newWord,e.data.en_definition.defn)
										}
										localStorage.setItem(wordWithoutSpace+"_Pronunciation",e.data.pronunciation)
										localStorage.setItem(wordWithoutSpace+"_Audio",e.data.audio)
										localStorage.setItem(wordWithoutSpace+"_CNDef",e.data.cn_definition.defn)
										localStorage.setItem(wordWithoutSpace+"_ENDef",e.data.en_definition.defn)
									}
								}
							})
						}
					})
				})
			}
			function addWord(word,definition){
				currentList.push({
					"definition":definition,
					"word":word
				})
				addWordLi(word,definition,currentList.length-1)
				add()
			}
			function addWordLi(word,definition,i){
				var newLi=document.createElement("li"),
				newLabel=document.createElement("label"),
				newP=document.createElement("p")
				newLi.setAttribute("class","menu")
				newLi.setAttribute("number",i+1)
				newLi.oncontextmenu=
				newLi.onclick=function(mouse){
					var index=this.getAttribute("number")*1-1
					showMenu(mouse,[{
						"onclick":function(){
							lookUp(currentList[index].word)
						},
						"text":[
							"Look Up",
							"查询"
						]
					},{
						"onclick":function(){
							showPrompt([
								"Change "+currentList[index].word+" to",
								"把 "+currentList[index].word+" 更改为"
							],function(newWord){
								showPrompt([
									"Change "+currentList[index].definition+" to",
									"把"+currentList[index].definition+"更改为"
								],function(newDefinition){
									currentList[index].word=newWord
									currentList[index].definition=newDefinition
									save()
								},null,currentList[index].definition)
							},null,currentList[index].word)
							closeMenu()
						},
						"text":[
							"Change",
							"更改"
						]
					},{
						"onclick":function(){
							showConfirm([
								"Do you want to delete "+currentList[index].word+"?",
								"您想要删除 "+currentList[index].word+" 吗？"
							],function(){
								currentList.splice(index,1)
								save()
							})
							closeMenu()
						},
						"text":[
							"Delete",
							"删除"
						]
					}])
				}
				newLabel.innerText=word
				newP.innerText=definition
				newLi.appendChild(newLabel)
				newLi.appendChild(newP)
				document.getElementById("WordListUl").appendChild(newLi)
			}
			function applyItem(serialNumber,list){
				if(serialNumber==0||serialNumber==null){
					currentItem=null
					localStorage.setItem("WordList",JSON.stringify(list))
				}else{
					currentItem=serialNumber
					localStorage.setItem("WordList",JSON.stringify(savedWordList.list[currentItem-1]))
				}
				reload()
			}
			function arrange(name){
				var wordCount=currentList.length*1,wordMin
				switch(name){
					case "flashcard":
					wordMin=1
					break
					case "quiz":
					wordMin=4
					break
					default:break
				}
				if(wordCount>=wordMin){
					localStorage.setItem("WordList",JSON.stringify({
						"list":currentList,
						"title":document.getElementById("TitleInput").value
					}))
					openWindow(name)
				}else{
					showAlert([
						"Too few words ("+wordCount+"/"+wordMin+")",
						"单词太少 ("+wordCount+"/"+wordMin+")"
					])
				}
			}
			function closeTrue(){
				localStorage.removeItem("WordList")
				currentItem=null
				reload()
			}
			function convertFormat(list){
				if(list.indexOf("RTH 1")!=-1){
					list=list.replace(/<br \/>|\r/g,"")
					var wla=[],
					wls=list.split("\n")
					for(var i=1;i<wls.length-1;i+=2){
						wla.push({
							"definition":wls[i+1],
							"word":wls[i]
						})
					}
					return{
						"list":wla,
						"title":""
					}
				}else{
					return JSON.parse(list)
				}
			}
			function edit(edit){
				if(edit){
					document.getElementsByClassName("start")[0].style.display="none"
					document.getElementsByClassName("edit")[0].style.display="block"
					document.getElementsByTagName("footer")[0].style.display="block"
					document.getElementsByClassName("back")[0].onclick=function(){
						showConfirm([
							"Do you want to close the document?",
							"您想要关闭文档吗？"
						],closeTrue)
					}
				}else{
					document.getElementsByClassName("start")[0].style.display=
					document.getElementsByClassName("edit")[0].style.display=
					document.getElementsByTagName("footer")[0].style.display=""
					document.getElementsByClassName("back")[0].onclick=mui.back
				}
			}
			function load(){
				var openedWordList=localStorage.getItem("WordList")
				if(openedWordList&&openedWordList!="undefined"){
					openedWordList=convertFormat(openedWordList)
					currentList=currentList.concat(openedWordList.list)
					document.getElementById("TitleInput").value=openedWordList.title
					for(var i=0;i<currentList.length;i++){
						addWordLi(currentList[i].word,currentList[i].definition,i)
					}
					edit(true)
				}else{
					if(savedWordList&&savedWordList.list){
						for(var i=savedWordList.list.length-1;i>=0;i--){
							var newLi=document.createElement("li")
							newLi.setAttribute("class","menu")
							newLi.innerText="M"+addZero(savedWordList.list.length-i,3)+". "
							if(savedWordList.list[i].title!=null&&savedWordList.list[i].title!=""){
								newLi.innerText+=savedWordList.list[i].title
							}else{
								switch(language){
									case "SimplifiedChinese":
									if(savedWordList.list[i].list[0]){
										newLi.innerText+=savedWordList.list[i].list[0].word+" 和另外 "+savedWordList.list[i].list.length+" 个单词"
									}else{
										newLi.innerText+="空白单词表"
									}
									break
									default:
									if(savedWordList.list[i].list[0]){
										newLi.innerText+=savedWordList.list[i].list[0].word+" and other "+savedWordList.list[i].list.length+" words"
									}else{
										newLi.innerText+="Empty Word List"
									}
									break
								}
							}
							newLi.setAttribute("number",i+1)
							newLi.onclick=function(){
								applyItem(this.getAttribute("number"))
							}
							document.getElementById("SavedWordListUl").appendChild(newLi)
						}
					}
					var friendEmail=localStorage.getItem("FriendEmail")
					if(friendEmail&&friendEmail!=""){
						if(userInfo){
							loadFriendWordList(friendEmail)
						}else{
							$.ajax({
								"url":"https://rthsoftware.azurewebsites.net/userdata/users.txt",
								"data":{
									"time":new Date().getTime()
								},
								"dataType":"json",
								"success":function(e){
									userInfo=e
									loadFriendWordList(friendEmail)
								}
							})
						}
					}else{
						loadAdminWordList()
					}
				}
				if(currentItem){
					document.getElementById("Delete").style.display=""
				}else{
					document.getElementById("Delete").style.display="none"
				}
			}
			function loadAdminWordList(){
				$.ajax({
					"url":"https://rthsoftware.azurewebsites.net/userdata/wordlist/admin.txt",
					"data":{
						"time":new Date().getTime()
					},
					"dataType":"json",
					"success":function(e){
						adminWordList=e
						var count=0
						for(var i=adminWordList.list.length-1;i>=0;i--){
							if(language!="SimplifiedChinese"&&!isChinese.test(JSON.stringify(adminWordList.list[i].list))||language=="SimplifiedChinese"&&isChinese.test(JSON.stringify(adminWordList.list[i].list))){
								count++
								var newLi=document.createElement("li")
								newLi.setAttribute("class","menu")
								newLi.innerText="A"+addZero(count,3)+". "
								if(adminWordList.list[i].title!=null&&adminWordList.list[i].title!=""){
									newLi.innerText+=adminWordList.list[i].title
								}else{
									switch(language){
										case "SimplifiedChinese":
										newLi.innerText+=adminWordList.list[i].list[0].word+" 和另外 "+adminWordList.list[i].list.length+" 个单词"
										break
										default:
										newLi.innerText+=adminWordList.list[i].list[0].word+" and other "+adminWordList.list[i].list.length+" words"
										break
									}
								}
								newLi.setAttribute("number",i+1)
								newLi.onclick=function(){
									var index=this.getAttribute("number")*1-1
									applyItem(0,adminWordList.list[index])
								}
								document.getElementById("SavedWordListUl").appendChild(newLi)
							}
						}
					}
				})
			}
			function loadFriendWordList(email){
				var username=verifyPassword(email).username
				if(username){
					$.ajax({
						"url":"https://rthsoftware.azurewebsites.net/userdata/wordlist/"+username+".txt",
						"data":{
							"time":new Date().getTime()
						},
						"dataType":"json",
						"success":function(e){
							friendWordList=e
							if(friendWordList.sharing){
								for(var i=friendWordList.list.length-1;i>=0;i--){
									var newLi=document.createElement("li")
									newLi.setAttribute("class","menu")
									newLi.innerText="F"+addZero(friendWordList.list.length-i,3)+". "
									if(friendWordList.list[i].title!=null&&friendWordList.list[i].title!=""){
										newLi.innerText+=friendWordList.list[i].title
									}else{
										switch(language){
											case "SimplifiedChinese":
											newLi.innerText+=friendWordList.list[i].list[0].word+" 和另外 "+friendWordList.list[i].list.length+" 个单词"
											break
											default:
											newLi.innerText+=friendWordList.list[i].list[0].word+" and other "+friendWordList.list[i].list.length+" words"
											break
										}
									}
									newLi.setAttribute("number",i+1)
									newLi.onclick=function(){
										var index=this.getAttribute("number")*1-1
										applyItem(0,friendWordList.list[index])
									}
									document.getElementById("SavedWordListUl").appendChild(newLi)
								}
							}else{
								switch(language){
									case "SimplifiedChinese":
									mui.toast(email+" 没有共享单词表")
									break
									default:
									mui.toast(email+" has no shared word lists")
									break
								}
							}
							loadAdminWordList()
						},
						"error":function(){
							switch(language){
								case "SimplifiedChinese":
								mui.toast(email+" 没有共享单词表")
								break
								default:
								mui.toast(email+" has no shared word lists")
								break
							}
							loadAdminWordList()
						}
					})
				}else{
					switch(language){
						case "SimplifiedChinese":
						mui.toast(email+" 不是有效的 RTH 账号")
						break
						default:
						mui.toast(email+" is not a valid RTH account")
						break
					}
					loadAdminWordList()
				}
			}
			function loadSavedWordList(){
				savedWordList=JSON.parse(localStorage.getItem("SavedWordList"))
				if(!savedWordList){
					savedWordList={
						"list":[],
						"sharing":false,
						"time":new Date().getTime(),
						"username":""
					}
				}
				for(var i=0;i<9999;i++){
					var oldWL=localStorage.getItem("WordList"+i)
					if(oldWL!=null&&oldWL!=""){
						savedWordList.list.push(convertFormat(oldWL))
						localStorage.removeItem("WordList"+i)
					}
				}
				localStorage.setItem("SavedWordList",JSON.stringify(savedWordList))
				if(login.username){
					$.ajax({
						"url":"https://rthsoftware.azurewebsites.net/userdata/wordlist/"+login.username+".txt",
						"data":{
							"time":new Date().getTime()
						},
						"dataType":"json",
						"success":function(e){
							if(e.username==savedWordList.username){
								if(e.time>savedWordList.time){
									savedWordList=e
								}
							}else{
								savedWordList.list=savedWordList.list.concat(e.list)
								savedWordList.time=new Date().getTime()
								savedWordList.username=login.username
							}
							if(JSON.stringify(savedWordList)!=JSON.stringify(e)&&savedWordList.list.length>0){
								submit(load)
							}else if(savedWordList.list.length<=0){
								savedWordList=e
								load()
							}else{
								load()
							}
						},
						"error":function(){
							if(savedWordList.list.length>0){
								submit(load)
							}else{
								load()
							}
						}
					})
				}else{
					load()
				}
			}
			function lookUp(word){
				if(word==""){
					if(document.getElementById("LookUpInput").value==""){
						showAlert([
							"Please enter the word you want to look up",
							"请输入要查询的单词"
						])
						return false
					}else{
						word=document.getElementById("LookUpInput").value
					}
				}
				openWindow(encodeURI("flashcard.html?word="+word))
			}
			function openLWL(file){
				if(file.name.split(".")[1]=="rth"){
					var reader=new FileReader()
					reader.onload=function(e){
						applyItem(0,convertFormat(this.result))
					}
					reader.readAsText(file)
				}else{
					showAlert([
						"Unable to open this type of file",
						"无法打开此类文件"
					])
				}
			}
			function reload(){
				scrollTo(0,0)
				currentList=[]
				document.getElementById("WordListUl").innerHTML=
				document.getElementById("SavedWordListUl").innerHTML=""
				if(!localStorage.getItem("WordList")){
					edit(false)
				}
				loadSavedWordList()
			}
			function save(){
				if(currentItem){
					savedWordList.list[currentItem-1].list=currentList
					savedWordList.list[currentItem-1].title=document.getElementById("TitleInput").value
				}else{
					savedWordList.list.push({
						"list":currentList,
						"title":document.getElementById("TitleInput").value
					})
					currentItem=savedWordList.list.length
				}
				submit(function(){
					applyItem(currentItem)
				})
			}
			function submit(callback){
				savedWordList.time=new Date().getTime()
				localStorage.setItem("SavedWordList",JSON.stringify(savedWordList))
				if(login.username){
					switch(language){
						case "SimplifiedChinese":
						mui.toast("正在提交")
						break
						default:
						mui.toast("Submitting")
						break
					}
					$.post("https://rthsoftware.azurewebsites.net/userdata/upload.php",{
						"dir":"wordlist/",
						"filename":login.username,
						"text":JSON.stringify(savedWordList)
					},function(){
						if(callback){
							callback()
						}
						switch(language){
							case "SimplifiedChinese":
							mui.toast("更改已保存")
							break
							default:
							mui.toast("Changes are saved")
							break
						}
					})
				}else{
					switch(language){
						case "SimplifiedChinese":
						mui.toast("更改已保存")
						break
						default:
						mui.toast("Changes are saved")
						break
					}
					if(userInfo){
						loginDialog()
					}
					if(callback){
						callback()
					}
				}
			}
			window.onkeydown=function(e){
				if(e.ctrlKey||e.metaKey){
					switch(e.keyCode){
						case 79:
						openDialog()
						return false
						break
						case 83:
						save()
						return false
						break
						default:break
					}
				}
			}
			document.getElementById("LookUpInput").onkeydown=function(e){
				if(e.keyCode==13&&this.value!=""){
					lookUp("")
				}
			}
			document.getElementsByTagName("button")[0].onclick=function(){
				lookUp("")
			}
			document.getElementById("NewWL").onclick=edit
			document.getElementById("OpenLWL").onclick=openDialog
			document.getElementById("SharingSettings").onclick=function(){
				if(!document.getElementsByClassName("popup")[0]){
					var newDiv=document.createElement("div"),
					newH1=document.createElement("h1"),
					newDescriptionDiv=document.createElement("div"),
					newInput=document.createElement("input"),
					newSharingButton=document.createElement("button"),
					newNotSharingButton=document.createElement("button"),
					newCloseDiv=document.createElement("div")
					newDiv.setAttribute("class","popup")
					newDescriptionDiv.setAttribute("class","description")
					newDescriptionDiv.style.marginBottom="20px"
					newInput.type="email"
					var friendEmail=localStorage.getItem("FriendEmail")
					if(friendEmail){
						newInput.value=friendEmail
					}
					if(savedWordList.sharing){
						newSharingButton.classList.add("active")
						newNotSharingButton.classList.remove("active")
					}else{
						newSharingButton.classList.remove("active")
						newNotSharingButton.classList.add("active")
					}
					newSharingButton.onclick=function(){
						newSharingButton.classList.add("active")
						newNotSharingButton.classList.remove("active")
					}
					newNotSharingButton.onclick=function(){
						newSharingButton.classList.remove("active")
						newNotSharingButton.classList.add("active")
					}
					newCloseDiv.setAttribute("class","close")
					newCloseDiv.innerText="×"
					newCloseDiv.onclick=function(){
						localStorage.setItem("FriendEmail",newInput.value)
						if(newSharingButton.classList.contains("active")){
							savedWordList.sharing=true
						}else{
							savedWordList.sharing=false
						}
						submit(reload)
						newDiv.style.opacity=""
						setTimeout(function(){
							document.body.removeChild(newDiv)
						},250)
					}
					switch(language){
						case "SimplifiedChinese":
						newH1.innerText="共享设置"
						newDescriptionDiv.innerText="如果您的好友选择了共享，您可以在下方的输入框中输入他/她的电子邮箱地址来查看他/她的单词表。"
						newInput.placeholder="电子邮箱"
						newSharingButton.innerText="共享"
						newNotSharingButton.innerText="不共享"
						break
						default:
						newH1.innerText="Sharing Settings"
						newDescriptionDiv.innerText="If your friend selects Sharing, you can enter his/her email address in the input box below to get his/her word lists."
						newInput.placeholder="Email"
						newSharingButton.innerText="Sharing"
						newNotSharingButton.innerText="Not Sharing"
						break
					}
					newDiv.appendChild(newH1)
					newDiv.appendChild(newDescriptionDiv)
					newDiv.appendChild(newInput)
					newDiv.appendChild(newSharingButton)
					newDiv.appendChild(newNotSharingButton)
					newDiv.appendChild(newCloseDiv)
					document.body.appendChild(newDiv)
					newDiv.style.top="calc(50% - "+(newDiv.offsetHeight/2)+"px)"
					setTimeout(function(){
						newDiv.style.opacity="1"
					},25)
				}
			}
			document.getElementById("Quiz").onclick=
			document.getElementById("FlashCard").onclick=function(){
				arrange(this.id.toLowerCase())
			}
			document.getElementById("Save").onclick=save
			document.getElementById("Add").onclick=add
			document.getElementById("SaveAs").onclick=function(){
				if(isElectron&&!isLinux){
					require("electron").remote.dialog.showSaveDialog({
						defaultPath:document.getElementById("TitleInput").value,
						filters:[{name:"RTH Toolbox Files",extensions:["rth"]}]
					},function(filename){
						if(filename){
							require("fs").writeFileSync(filename,JSON.stringify({
								"list":currentList,
								"title":document.getElementById("TitleInput").value
							}))
						}
					})
				}else{
					var filename=document.getElementById("TitleInput").value
					if(filename==""){
						filename=document.title
					}
					if(filename.indexOf(".")==-1){
						filename+=".rth"
					}
					var dl=document.createElement("a")
					dl.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(JSON.stringify({
						"list":currentList,
						"title":document.getElementById("TitleInput").value
					})))
					dl.setAttribute("download",filename)
					if(document.createEvent){
						var event=document.createEvent("MouseEvents")
						event.initEvent("click",true,true)
						dl.dispatchEvent(event)
					}else{
						dl.click()
					}
				}
			}
			document.getElementById("Delete").onclick=function(){
				showConfirm([
					"Do you want to delete the word list?",
					"您想要删除此单词表吗？"
				],function(){
					savedWordList.list.splice(currentItem-1,1)
					submit(closeTrue)
				})
			}
			document.getElementsByClassName("open-file")[0].onchange=function(e){
				openLWL(e.target.files[0])
			}
			switch(language){
				case "SimplifiedChinese":
				document.title="单词表"
				document.getElementById("LookUpInput").placeholder="输入要查询的单词"
				document.getElementsByTagName("button")[0].innerText="查询"
				document.getElementById("NewWL").innerText="新单词表"
				document.getElementById("OpenLWL").innerText="打开本地的单词表"
				document.getElementById("SharingSettings").innerText="共享设置"
				document.getElementById("TitleInput").placeholder="标题"
				document.getElementById("Quiz").innerText="测验"
				document.getElementById("SaveAs").innerText="另存为"
				document.getElementById("FlashCard").innerText="学习卡"
				document.getElementById("Save").innerText="保存"
				document.getElementById("Add").innerText="添加"
				document.getElementById("Delete").innerText="删除"
				break
				default:
				document.title="Word List"
				document.getElementById("LookUpInput").placeholder="Enter the word you want to look up"
				document.getElementsByTagName("button")[0].innerText="Look Up"
				document.getElementById("NewWL").innerText="New Word List"
				document.getElementById("OpenLWL").innerText="Open Local Word List"
				document.getElementById("SharingSettings").innerText="Sharing Settings"
				document.getElementById("TitleInput").placeholder="Title"
				document.getElementById("Quiz").innerText="Quiz"
				document.getElementById("SaveAs").innerText="Save As"
				document.getElementById("FlashCard").innerText="Flash Card"
				document.getElementById("Save").innerText="Save"
				document.getElementById("Add").innerText="Add"
				document.getElementById("Delete").innerText="Delete"
				break
			}
			document.getElementsByClassName("mui-title")[0].innerText=document.title
			if(isMobile){
				document.getElementById("OpenLWL").style.display="none"
			}else{
				document.getElementById("LookUpInput").focus()
			}
			if(isEdge||isLinux||isMobile){
				document.getElementById("SaveAs").style.display="none"
			}
			loadSavedWordList()
		</script>
	</body>
</html>
