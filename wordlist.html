<!DOCTYPE html>
<html>
	<head>
		<!--Code written by Shangzhen Yang-->
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,viewport-fit=cover">
		<meta name="theme-color" content="#0066cc">
		<link href="css/mui.min.css" rel="stylesheet">
		<link href="css/general.css" rel="stylesheet">
		<style>
			footer,
			.quiz,
			#AnswerUl{
				display:none;
			}
			footer div{
				width:50%;
			}
			ul.menu,
			.answer,
			#NextButton,
			#QuizOptionUl{
				margin-top:15px;
			}
			.edit{
				display:none;
				margin-bottom:60px;
			}
			.quiz ul.menu,
			#OptionUl{
				margin-top:0px;
			}
		</style>
	</head>
	<body>
		<header class="mui-bar mui-bar-nav title"></header>
		<div class="mui-content">
			<div class="start">
				<div class="mui-input-row">
					<input id="LookUpInput" type="text" class="mui-input-clear">
				</div>
				<div class="btn-bg-img">
					<button id="LookUpButton" type="button" class="mui-btn mui-btn-blue mui-btn-block"></button>
				</div>
				<ul class="menu">
					<li id="NewWL" class="menu"></li>
					<li id="OpenLWL" class="menu"></li>
					<li id="SharingSettings" class="menu"></li>
					<span id="SavedWordListUl"></span>
				</ul>
			</div>
			<div class="edit">
				<div class="mui-input-row">
					<input id="TitleInput" type="text" class="mui-input-clear">
				</div>
				<ul id="OptionUl" class="menu">
					<li id="Quiz" class="menu"></li>
					<li id="SaveAs" class="menu"></li>
					<li id="Delete" class="menu"></li>
					<li id="FlashCard" class="menu"></li>
				</ul>
				<ul id="WordListUl" class="menu"></ul>
			</div>
			<div class="quiz">
				<ul class="menu card">
					<li id="Show" class="menu"></li>
				</ul>
				<div class="answer">
					<div id="EnterWordDiv" class="mui-input-row">
						<label id="WordLabel"></label>
						<input id="EnteredWord" type="text">
					</div>
					<div id="EnterDefinitionDiv" class="mui-input-row">
						<label id="DefinitionLabel"></label>
						<input id="EnteredDefinition" type="text">
					</div>
					<ul id="AnswerUl" class="menu">
						<li id="Option1" class="menu"></li>
						<li id="Option2" class="menu"></li>
						<li id="Option3" class="menu"></li>
						<li id="Option4" class="menu"></li>
					</ul>
				</div>
				<div class="btn-bg-img">
					<button id="NextButton" type="button" class="mui-btn mui-btn-blue mui-btn-block"></button>
				</div>
				<ul id="QuizOptionUl" class="menu">
					<li id="Restart" class="menu"></li>
					<li id="Speak" class="menu"></li>
					<li class="menu">
						<span id="MultipleChoice"></span>
						<div id="MultipleChoiceSwitch" class="mui-switch mui-switch-blue mui-switch-mini">
							<div class="mui-switch-handle"></div>
						</div>
					</li>
					<li id="SpeakWordsLi" class="menu">
						<span id="SpeakWords"></span>
						<div id="SpeakWordsSwitch" class="mui-switch mui-switch-blue mui-switch-mini">
							<div class="mui-switch-handle"></div>
						</div>
					</li>
					<li id="SpeakDefinitionsLi" class="menu">
						<span id="SpeakDefinitions"></span>
						<div id="SpeakDefinitionsSwitch" class="mui-switch mui-switch-blue mui-switch-mini">
							<div class="mui-switch-handle"></div>
						</div>
					</li>
					<li class="menu">
						<span id="EnterWords"></span>
						<div id="EnterWordsSwitch" class="mui-switch mui-switch-blue mui-switch-mini mui-active">
							<div class="mui-switch-handle"></div>
						</div>
					</li>
					<li class="menu">
						<span id="EnterDefinitions"></span>
						<div id="EnterDefinitionsSwitch" class="mui-switch mui-switch-blue mui-switch-mini">
							<div class="mui-switch-handle"></div>
						</div>
					</li>
					<li class="menu">
						<span id="ShowWords"></span>
						<div id="ShowWordsSwitch" class="mui-switch mui-switch-blue mui-switch-mini">
							<div class="mui-switch-handle"></div>
						</div>
					</li>
					<li class="menu">
						<span id="ShowDefinitions"></span>
						<div id="ShowDefinitionsSwitch" class="mui-switch mui-switch-blue mui-switch-mini mui-active">
							<div class="mui-switch-handle"></div>
						</div>
					</li>
				</ul>
			</div>
		</div>
		<footer>
			<div id="Save"></div>
			<div id="Add"></div>
		</footer>
		<input class="open-file" type="file" accept=".rth">
		<script src="cordova.js"></script>
		<script src="js/mui.min.js"></script>
		<script src="js/jquery.min.js"></script>
		<script src="js/md5.min.js"></script>
		<script src="js/general.js"></script>
		<script type="text/javascript">
			var adminWordList,
			correctDefinition,
			correctInt=0,
			currentItem,
			currentList=[],
			correctWord,
			friendWordList,
			handle=document.getElementsByClassName("mui-switch-handle"),
			mistakes,
			outOfOrder=[],
			progress=1,
			savedWordList,
			settingsChanged,
			showAnswer=false,
			wordIndex
			function add(){
				showPrompt([
					"Enter a new word",
					"输入新单词"
				],function(newWord){
					showPrompt([
						"Enter the definition of the new word",
						"输入新单词的释义"
					],function(newDefinition){
						addWord(newWord,newDefinition)
					},null,null,function(){
						var wordWithoutSpace=newWord.replace(/\s/g,"").toLowerCase()
						if(localStorage.getItem(wordWithoutSpace+"_CNDef")!=null){
							var CNDef=localStorage.getItem(wordWithoutSpace+"_CNDef"),
							ENDef=localStorage.getItem(wordWithoutSpace+"_ENDef")
							if(language=="SimplifiedChinese"&&CNDef!=null){
								addWord(newWord,CNDef)
							}else if(ENDef!=null){
								addWord(newWord,ENDef)
							}
						}else{
							$.ajax({
								"url":"https://rths.tk/shanbay.php",
								"data":{
									"word":newWord
								},
								"dataType":"json",
								"success":function(e){
									if(e.msg=="SUCCESS"){
										if(language=="SimplifiedChinese"&&e.data.cn_definition.defn!=null){
											addWord(newWord,e.data.cn_definition.defn)
										}else if(e.data.en_definition.defn!=null){
											addWord(newWord,e.data.en_definition.defn)
										}
										localStorage.setItem(wordWithoutSpace+"_Pronunciation",e.data.pronunciation)
										localStorage.setItem(wordWithoutSpace+"_Audio",e.data.audio)
										localStorage.setItem(wordWithoutSpace+"_CNDef",e.data.cn_definition.defn)
										localStorage.setItem(wordWithoutSpace+"_ENDef",e.data.en_definition.defn)
									}
								}
							})
						}
					})
				})
			}
			function addMistake(word,definition){
				var repeat=false
				for(var i=0;i<mistakes.list.length;i++){
					if(mistakes.list[i].word==word){
						repeat=true
					}
				}
				if(!repeat){
					mistakes.list.push({
						"definition":definition,
						"word":word
					})
				}
			}
			function addWord(word,definition){
				currentList.push({
					"definition":definition,
					"word":word
				})
				addWordLi(word,definition,currentList.length-1)
				add()
			}
			function addWordLi(word,definition,i){
				var newLi=document.createElement("li"),
				newLabel=document.createElement("label"),
				newP=document.createElement("p")
				newLi.setAttribute("class","menu")
				newLi.setAttribute("number",i+1)
				newLi.oncontextmenu=
				newLi.onclick=function(mouse){
					var index=this.getAttribute("number")*1-1
					showMenu(mouse,[{
						"onclick":function(){
							lookUp(currentList[index].word)
						},
						"text":[
							"Look Up",
							"查询"
						]
					},{
						"onclick":function(){
							showPrompt([
								"Change "+currentList[index].word+" to",
								"把 "+currentList[index].word+" 更改为"
							],function(newWord){
								showPrompt([
									"Change "+currentList[index].definition+" to",
									"把"+currentList[index].definition+"更改为"
								],function(newDefinition){
									currentList[index].word=newWord
									currentList[index].definition=newDefinition
									save()
								},null,currentList[index].definition)
							},null,currentList[index].word)
							closeMenu()
						},
						"text":[
							"Change",
							"更改"
						]
					},{
						"onclick":function(){
							showConfirm([
								"Do you want to delete "+currentList[index].word+"?",
								"您想删除 "+currentList[index].word+" 吗？"
							],function(){
								currentList.splice(index,1)
								save()
							})
							closeMenu()
						},
						"text":[
							"Delete",
							"删除"
						]
					}])
				}
				newLabel.innerText=word
				newP.innerText=definition
				newLi.appendChild(newLabel)
				newLi.appendChild(newP)
				document.getElementById("WordListUl").appendChild(newLi)
			}
			function applyItem(serialNumber,list){
				if(serialNumber==0||serialNumber==null){
					currentItem=null
					localStorage.setItem("WordList",JSON.stringify(list))
				}else{
					currentItem=serialNumber
					localStorage.setItem("WordList",JSON.stringify(savedWordList.list[currentItem-1]))
				}
				if(document.getElementsByClassName("quiz")[0].style.display==""){
					reload()
				}
			}
			function arrange(name){
				var wordCount=currentList.length*1,wordMin
				switch(name){
					case "flashcard":
					wordMin=1
					break
					case "quiz":
					wordMin=4
					break
					default:break
				}
				if(wordCount>=wordMin){
					if(name=="quiz"){
						save(function(){
							openDiv(name)
						})
					}else{
						localStorage.setItem("WordList",JSON.stringify({
							"list":currentList,
							"title":document.getElementById("TitleInput").value
						}))
						openWindow(name)
					}
				}else{
					showAlert([
						"Too few words ("+wordCount+"/"+wordMin+")",
						"单词太少 ("+wordCount+"/"+wordMin+")"
					])
				}
			}
			function closeTrue(){
				localStorage.removeItem("WordList")
				currentItem=null
				reload()
			}
			function convertFormat(list){
				if(list.indexOf("RTH 1")!=-1){
					list=list.replace(/<br \/>|\r/g,"")
					var wla=[],
					wls=list.split("\n")
					for(var i=1;i<wls.length-1;i+=2){
						wla.push({
							"definition":wls[i+1],
							"word":wls[i]
						})
					}
					return{
						"list":wla,
						"title":""
					}
				}else{
					return JSON.parse(list)
				}
			}
			function end(){
				var correctRate=Math.round(100-(mistakes.list.length/progress)*100)
				if(mistakes.list.length>0){
					currentItem=null
					localStorage.setItem("WordList",JSON.stringify(mistakes))
				}
				showAlert([
					"Correct rate: "+correctRate+"%",
					"正确率："+correctRate+"%"
				],reload)
			}
			function generateOrder(){
				wordIndex=Math.round(Math.random()*currentList.length-1)+1
				if(arrayContains(wordIndex,outOfOrder)||wordIndex==0){
					generateOrder()
				}
			}
			function load(){
				var openedWordList=localStorage.getItem("WordList")
				if(openedWordList&&openedWordList!="undefined"){
					openedWordList=convertFormat(openedWordList)
					currentList=currentList.concat(openedWordList.list)
					document.getElementById("TitleInput").value=openedWordList.title
					for(var i=0;i<currentList.length;i++){
						addWordLi(currentList[i].word,currentList[i].definition,i)
					}
					openDiv("edit")
				}else{
					if(savedWordList&&savedWordList.list){
						for(var i=savedWordList.list.length-1;i>=0;i--){
							var newLi=document.createElement("li")
							newLi.setAttribute("class","menu")
							newLi.innerText="M"+addZero(savedWordList.list.length-i,3)+". "
							if(savedWordList.list[i].title!=null&&savedWordList.list[i].title!=""){
								newLi.innerText+=savedWordList.list[i].title
							}else{
								switch(language){
									case "SimplifiedChinese":
									if(savedWordList.list[i].list[0]){
										newLi.innerText+=savedWordList.list[i].list[0].word+" 和另外 "+savedWordList.list[i].list.length+" 个单词"
									}else{
										newLi.innerText+="空白单词表"
									}
									break
									default:
									if(savedWordList.list[i].list[0]){
										newLi.innerText+=savedWordList.list[i].list[0].word+" and other "+savedWordList.list[i].list.length+" words"
									}else{
										newLi.innerText+="Empty Word List"
									}
									break
								}
							}
							newLi.setAttribute("number",i+1)
							newLi.onclick=function(){
								applyItem(this.getAttribute("number"))
							}
							document.getElementById("SavedWordListUl").appendChild(newLi)
						}
					}
					var friendEmail=localStorage.getItem("FriendEmail")
					if(friendEmail&&friendEmail!=""){
						loadFriendWordList(friendEmail)
					}else{
						loadAdminWordList()
					}
				}
				if(currentItem){
					document.getElementById("Delete").style.display=""
				}else{
					document.getElementById("Delete").style.display="none"
				}
			}
			function loadAdminWordList(){
				$.ajax({
					"url":"https://rths.tk/userdata/wordlist/admin.txt",
					"data":{
						"time":new Date().getTime()
					},
					"dataType":"json",
					"success":function(e){
						adminWordList=e
						var count=0
						for(var i=adminWordList.list.length-1;i>=0;i--){
							if(language!="SimplifiedChinese"&&!isChinese.test(JSON.stringify(adminWordList.list[i].list))||language=="SimplifiedChinese"&&isChinese.test(JSON.stringify(adminWordList.list[i].list))){
								count++
								var newLi=document.createElement("li")
								newLi.setAttribute("class","menu")
								newLi.innerText="A"+addZero(count,3)+". "
								if(adminWordList.list[i].title!=null&&adminWordList.list[i].title!=""){
									newLi.innerText+=adminWordList.list[i].title
								}else{
									switch(language){
										case "SimplifiedChinese":
										newLi.innerText+=adminWordList.list[i].list[0].word+" 和另外 "+adminWordList.list[i].list.length+" 个单词"
										break
										default:
										newLi.innerText+=adminWordList.list[i].list[0].word+" and other "+adminWordList.list[i].list.length+" words"
										break
									}
								}
								newLi.setAttribute("number",i+1)
								newLi.onclick=function(){
									var index=this.getAttribute("number")*1-1
									applyItem(0,adminWordList.list[index])
								}
								document.getElementById("SavedWordListUl").appendChild(newLi)
							}
						}
					}
				})
			}
			function loadFriendWordList(email){
				$.post("https://rths.tk/userdata/verify.php",{
					"email":email,
					"password":new Date().getTime(),
					"time":new Date().getTime()
				},function(verifyResult){
					if(verifyResult.username){
						$.ajax({
							"url":"https://rths.tk/userdata/wordlist/"+verifyResult.username+".txt",
							"data":{
								"time":new Date().getTime()
							},
							"dataType":"json",
							"success":function(e){
								friendWordList=e
								if(friendWordList.sharing){
									for(var i=friendWordList.list.length-1;i>=0;i--){
										var newLi=document.createElement("li")
										newLi.setAttribute("class","menu")
										newLi.innerText="F"+addZero(friendWordList.list.length-i,3)+". "
										if(friendWordList.list[i].title!=null&&friendWordList.list[i].title!=""){
											newLi.innerText+=friendWordList.list[i].title
										}else{
											switch(language){
												case "SimplifiedChinese":
												newLi.innerText+=friendWordList.list[i].list[0].word+" 和另外 "+friendWordList.list[i].list.length+" 个单词"
												break
												default:
												newLi.innerText+=friendWordList.list[i].list[0].word+" and other "+friendWordList.list[i].list.length+" words"
												break
											}
										}
										newLi.setAttribute("number",i+1)
										newLi.onclick=function(){
											var index=this.getAttribute("number")*1-1
											applyItem(0,friendWordList.list[index])
										}
										document.getElementById("SavedWordListUl").appendChild(newLi)
									}
								}else{
									showToast([
										email+" has no shared word lists",
										email+" 没有共享单词表"
									])
								}
								loadAdminWordList()
							},
							"error":function(){
								showToast([
									email+" has no shared word lists",
									email+" 没有共享单词表"
								])
								loadAdminWordList()
							}
						})
					}else{
						showToast([
							email+" is not a valid RTH account",
							email+" 不是有效的 RTH 账号"
						])
						loadAdminWordList()
					}
				},"json")
			}
			function loadQuestion(){
				showAnswer=false
				document.getElementById("EnteredWord").value=""
				document.getElementById("EnteredDefinition").value=""
				document.getElementsByClassName("mui-title")[0].innerText=document.getElementById("Quiz").innerText+" ("+progress+"/"+currentList.length+")"
				generateOrder()
				outOfOrder.push(wordIndex)
				correctWord=currentList[wordIndex-1].word
				correctDefinition=currentList[wordIndex-1].definition
				if(document.getElementById("MultipleChoiceSwitch").classList.contains("mui-active")){
					document.getElementById("Option1").innerText=
					document.getElementById("Option2").innerText=
					document.getElementById("Option3").innerText=
					document.getElementById("Option4").innerText=""
					var optionIndex=0,optionStr=""
					correctInt=Math.round(Math.random()*3)
					var options=[wordIndex]
					if(document.getElementById("EnterWordsSwitch").classList.contains("mui-active")){
						optionStr=correctWord
					}else if(document.getElementById("EnterDefinitionsSwitch").classList.contains("mui-active")){
						optionStr=correctDefinition
					}
					switch(correctInt){
						case 0:
						document.getElementById("Option1").innerText=optionStr
						break
						case 1:
						document.getElementById("Option2").innerText=optionStr
						break
						case 2:
						document.getElementById("Option3").innerText=optionStr
						break
						case 3:
						document.getElementById("Option4").innerText=optionStr
						break
						default:break
					}
					var generateOption=function(){
						optionIndex=Math.round(Math.random()*currentList.length-1)+1
						if(arrayContains(optionIndex,options)||optionStr==null||optionIndex==0){
							generateOption()
						}else{
							if(document.getElementById("EnterWordsSwitch").classList.contains("mui-active")){
								optionStr=currentList[optionIndex-1].word
							}else if(document.getElementById("EnterDefinitionsSwitch").classList.contains("mui-active")){
								optionStr=currentList[optionIndex-1].definition
							}
							options.push(optionIndex)
						}
					}
					for(var i=0;i<4;i++){
						generateOption()
						if(document.getElementById("Option1").innerText==""){
							document.getElementById("Option1").innerText=optionStr
						}else if(document.getElementById("Option2").innerText==""){
							document.getElementById("Option2").innerText=optionStr
						}else if(document.getElementById("Option3").innerText==""){
							document.getElementById("Option3").innerText=optionStr
						}else if(document.getElementById("Option4").innerText==""){
							document.getElementById("Option4").innerText=optionStr
						}
					}
				}
				if(document.getElementById("ShowWordsSwitch").classList.contains("mui-active")){
					document.getElementById("Show").innerText=correctWord
				}else if(document.getElementById("ShowDefinitionsSwitch").classList.contains("mui-active")){
					document.getElementById("Show").innerText=correctDefinition
				}else{
					switch(language){
						case "SimplifiedChinese":
						document.getElementById("Show").innerText="没有可显示的内容"
						break
						default:
						document.getElementById("Show").innerText="There is nothing to show"
						break
					}
				}
				speak()
			}
			function loadSavedWordList(){
				savedWordList=JSON.parse(localStorage.getItem("SavedWordList"))
				if(!savedWordList){
					savedWordList={
						"list":[],
						"sharing":false,
						"time":new Date().getTime(),
						"username":""
					}
				}
				for(var i=0;i<9999;i++){
					var oldWL=localStorage.getItem("WordList"+i)
					if(oldWL!=null&&oldWL!=""){
						savedWordList.list.push(convertFormat(oldWL))
						localStorage.removeItem("WordList"+i)
					}
				}
				localStorage.setItem("SavedWordList",JSON.stringify(savedWordList))
				if(login.username){
					$.ajax({
						"url":"https://rths.tk/userdata/wordlist/"+login.username+".txt",
						"data":{
							"time":new Date().getTime()
						},
						"dataType":"json",
						"success":function(e){
							if(e.username==savedWordList.username){
								if(e.time>savedWordList.time){
									savedWordList=e
								}
							}else{
								savedWordList.list=savedWordList.list.concat(e.list)
								savedWordList.time=new Date().getTime()
								savedWordList.username=login.username
							}
							if(JSON.stringify(savedWordList)!=JSON.stringify(e)&&savedWordList.list.length>0){
								submit(load)
							}else if(savedWordList.list.length<=0){
								savedWordList=e
								load()
							}else{
								load()
							}
						},
						"error":function(e){
							if(e.status!=0&&savedWordList.list.length>0){
								submit(load)
							}else{
								load()
							}
						}
					})
				}else{
					load()
				}
			}
			function lookUp(word){
				if(!word){
					if(document.getElementById("LookUpInput").value==""){
						showAlert([
							"Please enter the word you want to look up",
							"请输入要查询的单词"
						])
						return false
					}else{
						word=document.getElementById("LookUpInput").value
					}
				}
				openWindow(encodeURI("flashcard.html?word="+word))
			}
			function openDiv(className){
				document.getElementsByClassName("mui-title")[0].innerText=document.title
				switch(className){
					case "edit":
					document.getElementsByClassName("start")[0].style.display="none"
					document.getElementsByClassName("edit")[0].style.display="block"
					document.getElementsByClassName("quiz")[0].style.display=""
					document.getElementsByTagName("footer")[0].style.display="block"
					document.getElementsByClassName("back")[0].onclick=function(){
						showConfirm([
							"Do you want to close the document?",
							"您想关闭文档吗？"
						],closeTrue)
					}
					break
					case "quiz":
					document.getElementsByClassName("start")[0].style.display="none"
					document.getElementsByClassName("edit")[0].style.display=""
					document.getElementsByClassName("quiz")[0].style.display="block"
					document.getElementsByTagName("footer")[0].style.display=""
					document.getElementsByClassName("back")[0].onclick=end
					restartQuiz()
					break
					case "start":
					document.getElementsByClassName("start")[0].style.display=
					document.getElementsByClassName("edit")[0].style.display=
					document.getElementsByClassName("quiz")[0].style.display=
					document.getElementsByTagName("footer")[0].style.display=""
					document.getElementsByClassName("back")[0].onclick=mui.back
					break
					default:break
				}
			}
			function openLWL(file){
				if(file.name.split(".")[1]=="rth"){
					var reader=new FileReader()
					reader.onload=function(e){
						applyItem(0,convertFormat(this.result))
					}
					reader.readAsText(file)
				}else{
					showAlert([
						"Unable to open this type of file",
						"无法打开此类文件"
					])
				}
			}
			function optionClicked(clickedNum){
				if(document.getElementsByClassName("quiz")[0].style.display=="block"&&document.getElementById("MultipleChoiceSwitch").classList.contains("mui-active")){
					if(clickedNum==correctInt){
						showAnswer=true
						next()
					}else{
						addMistake(correctWord,correctDefinition)
						showAlert([
							"Not this one",
							"不是这个"
						])
					}
				}
			}
			function next(){
				if(settingsChanged){
					showAlert([
						"Click Restart to apply the settings",
						"单击重新开始使设置生效"
					])
				}else{
					if(!showAnswer&&document.getElementById("MultipleChoiceSwitch").classList.contains("mui-active")){
						addMistake(correctWord,correctDefinition)
					}
					if(!showAnswer&&!document.getElementById("MultipleChoiceSwitch").classList.contains("mui-active")){
						showAnswer=true
						if(document.getElementById("EnterWordsSwitch").classList.contains("mui-active")){
							if(document.getElementById("EnteredWord").value.replace(/(\s*$)/g,"").toLowerCase()==correctWord.toLowerCase()){
								switch(language){
									case "SimplifiedChinese":
									document.getElementById("EnteredWord").value+="（正确）"
									break
									default:
									document.getElementById("EnteredWord").value+=" (Correct)"
									break
								}
							}else{
								addMistake(correctWord,correctDefinition)
								switch(language){
									case "SimplifiedChinese":
									document.getElementById("EnteredWord").value+=" ≠ "+correctWord+"（错误）"
									break
									default:
									document.getElementById("EnteredWord").value+=" ≠ "+correctWord+" (Incorrect)"
									break
								}
							}
						}
						if(document.getElementById("EnterDefinitionsSwitch").classList.contains("mui-active")){
							var enteredDefWithoutSpace=document.getElementById("EnteredDefinition").value.replace(/\s+/g,""),
							correctDefWithoutSpace=correctDefinition.replace(/\s+/g,""),
							incorrect=function(){
								addMistake(correctWord,correctDefinition)
								switch(language){
									case "SimplifiedChinese":
									document.getElementById("EnteredDefinition").value+=" ≠ "+correctDefinition+"（错误）"
									break
									default:
									document.getElementById("EnteredDefinition").value+=" ≠ "+correctDefinition+" (Incorrect)"
									break
								}
							}
							if(enteredDefWithoutSpace==correctDefWithoutSpace){
								switch(language){
									case "SimplifiedChinese":
									document.getElementById("EnteredDefinition").value+="（正确）"
									break
									default:
									document.getElementById("EnteredDefinition").value+=" (Correct)"
									break
								}
							}else if(correctDefWithoutSpace.indexOf(enteredDefWithoutSpace)!=-1||enteredDefWithoutSpace.indexOf(correctDefWithoutSpace)!=-1){
								if(enteredDefWithoutSpace==""){
									incorrect()
								}else{
									var defCorrectRate
									if(correctDefinition.length>enteredDefWithoutSpace.length){
										defCorrectRate=(enteredDefWithoutSpace.length/correctDefinition.length)*100
									}else{
										defCorrectRate=(correctDefinition.length/enteredDefWithoutSpace.length)*100
									}
									if(defCorrectRate<1){
										defCorrectRate=1
									}else if(defCorrectRate>99){
										defCorrectRate=99
									}
									switch(language){
										case "SimplifiedChinese":
										document.getElementById("EnteredDefinition").value+=" ≈ "+correctDefinition+"（"+defCorrectRate+"% 正确）"
										break
										default:
										document.getElementById("EnteredDefinition").value+=" ≈ "+correctDefinition+" ("+defCorrectRate+"% Correct)"
										break
									}
								}
							}else{
								incorrect()
							}
						}
					}else{
						if(progress>=currentList.length){
							end()
						}else{
							progress+=1
							loadQuestion()
						}
					}
				}
			}
			function reload(){
				scrollTo(0,0)
				currentList=[]
				document.getElementById("WordListUl").innerHTML=
				document.getElementById("SavedWordListUl").innerHTML=""
				if(!localStorage.getItem("WordList")){
					openDiv("start")
				}
				loadSavedWordList()
			}
			function restartQuiz(){
				settingsChanged=false
				progress=1
				outOfOrder=[]
				mistakes.list=[]
				loadQuestion()
				if(document.getElementById("MultipleChoiceSwitch").classList.contains("mui-active")){
					document.getElementById("AnswerUl").style.display="block"
					document.getElementById("EnterWordDiv").style.display="none"
					document.getElementById("EnterDefinitionDiv").style.display="none"
				}else{
					document.getElementById("AnswerUl").style.display=""
					if(document.getElementById("EnterWordsSwitch").classList.contains("mui-active")&&document.getElementById("EnterDefinitionsSwitch").classList.contains("mui-active")){
						document.getElementById("EnterWordDiv").style.display=""
						document.getElementById("EnterDefinitionDiv").style.display=""
					}else if(document.getElementById("EnterWordsSwitch").classList.contains("mui-active")&&!document.getElementById("EnterDefinitionsSwitch").classList.contains("mui-active")){
						document.getElementById("EnterWordDiv").style.display=""
						document.getElementById("EnterDefinitionDiv").style.display="none"
					}else if(!document.getElementById("EnterWordsSwitch").classList.contains("mui-active")&&document.getElementById("EnterDefinitionsSwitch").classList.contains("mui-active")){
						document.getElementById("EnterWordDiv").style.display="none"
						document.getElementById("EnterDefinitionDiv").style.display=""
					}else{
						document.getElementById("EnterWordDiv").style.display="none"
						document.getElementById("EnterDefinitionDiv").style.display="none"
					}
				}
				document.getElementById("NextButton").style.display=""
			}
			function save(callback){
				if(currentItem){
					savedWordList.list[currentItem-1].list=currentList
					savedWordList.list[currentItem-1].title=document.getElementById("TitleInput").value
				}else{
					savedWordList.list.push({
						"list":currentList,
						"title":document.getElementById("TitleInput").value
					})
					currentItem=savedWordList.list.length
				}
				submit(function(){
					if(callback){
						callback()
					}
					applyItem(currentItem)
				})
			}
			function speak(){
				if(window.speechSynthesis){
					var speakText=""
					if(document.getElementById("SpeakWordsSwitch").classList.contains("mui-active")){
						speakText+=correctWord+". "
					}
					if(document.getElementById("SpeakDefinitionsSwitch").classList.contains("mui-active")){
						speakText+=correctDefinition+". "
					}
					window.speechSynthesis.speak(new SpeechSynthesisUtterance(speakText))
				}
			}
			function submit(callback){
				savedWordList.time=new Date().getTime()
				localStorage.setItem("SavedWordList",JSON.stringify(savedWordList))
				if(login.username){
					showToast([
						"Submitting",
						"正在提交"
					])
					$.post("https://rths.tk/userdata/upload.php",{
						"dir":"wordlist/",
						"filename":login.username,
						"text":JSON.stringify(savedWordList)
					},function(){
						if(callback){
							callback()
						}
						showToast([
							"Changes are saved",
							"更改已保存"
						])
					})
				}else{
					showToast([
						"Changes are saved",
						"更改已保存"
					])
					if(!localStorage.getItem("Username")){
						loginDialog()
					}
					if(callback){
						callback()
					}
				}
			}
			window.onkeydown=function(e){
				if(e.ctrlKey||e.metaKey){
					switch(e.keyCode){
						case 79:
						openDialog()
						return false
						break
						case 83:
						save()
						return false
						break
						default:break
					}
				}else{
					switch(e.keyCode){
						case 49:
						optionClicked(0)
						break
						case 50:
						optionClicked(1)
						break
						case 51:
						optionClicked(2)
						break
						case 52:
						optionClicked(3)
						break
						default:break
					}
				}
			}
			document.getElementById("LookUpInput").onkeydown=function(e){
				if(e.keyCode==13&&this.value!=""){
					lookUp()
				}
			}
			document.getElementById("LookUpButton").onclick=function(){
				lookUp()
			}
			document.getElementById("NewWL").onclick=function(){
				openDiv("edit")
			}
			document.getElementById("OpenLWL").onclick=openDialog
			document.getElementById("SharingSettings").onclick=function(){
				if(!document.getElementsByClassName("popup")[0]){
					var newDiv=document.createElement("div"),
					newH1=document.createElement("h1"),
					newDescriptionDiv=document.createElement("div"),
					newInput=document.createElement("input"),
					newSharingButton=document.createElement("button"),
					newNotSharingButton=document.createElement("button"),
					newCloseDiv=document.createElement("div")
					newDiv.setAttribute("class","popup")
					newDescriptionDiv.setAttribute("class","description")
					newDescriptionDiv.style.marginBottom="20px"
					newInput.type="email"
					var friendEmail=localStorage.getItem("FriendEmail")
					if(friendEmail){
						newInput.value=friendEmail
					}
					if(savedWordList.sharing){
						newSharingButton.classList.add("active")
						newNotSharingButton.classList.remove("active")
					}else{
						newSharingButton.classList.remove("active")
						newNotSharingButton.classList.add("active")
					}
					newSharingButton.onclick=function(){
						newSharingButton.classList.add("active")
						newNotSharingButton.classList.remove("active")
					}
					newNotSharingButton.onclick=function(){
						newSharingButton.classList.remove("active")
						newNotSharingButton.classList.add("active")
					}
					newCloseDiv.setAttribute("class","close")
					newCloseDiv.innerText="×"
					newCloseDiv.onclick=function(){
						localStorage.setItem("FriendEmail",newInput.value)
						if(newSharingButton.classList.contains("active")){
							savedWordList.sharing=true
						}else{
							savedWordList.sharing=false
						}
						submit(reload)
						newDiv.style.opacity=""
						setTimeout(function(){
							document.body.removeChild(newDiv)
						},250)
					}
					switch(language){
						case "SimplifiedChinese":
						newH1.innerText="共享设置"
						newDescriptionDiv.innerText="如果您的好友选择了共享，您可以在下方的输入框中输入他/她的电子邮箱地址来查看他/她的单词表。"
						newInput.placeholder="电子邮箱"
						newSharingButton.innerText="共享"
						newNotSharingButton.innerText="不共享"
						break
						default:
						newH1.innerText="Sharing Settings"
						newDescriptionDiv.innerText="If your friend selects Sharing, you can enter his/her email address in the input box below to get his/her word lists."
						newInput.placeholder="Email"
						newSharingButton.innerText="Sharing"
						newNotSharingButton.innerText="Not Sharing"
						break
					}
					newDiv.appendChild(newH1)
					newDiv.appendChild(newDescriptionDiv)
					newDiv.appendChild(newInput)
					newDiv.appendChild(newSharingButton)
					newDiv.appendChild(newNotSharingButton)
					newDiv.appendChild(newCloseDiv)
					document.body.appendChild(newDiv)
					newDiv.style.top="calc(50% - "+(newDiv.offsetHeight/2)+"px)"
					setTimeout(function(){
						newDiv.style.opacity="1"
					},25)
				}
			}
			document.getElementById("Quiz").onclick=
			document.getElementById("FlashCard").onclick=function(){
				arrange(this.id.toLowerCase())
			}
			document.getElementById("Save").onclick=function(){
				save()
			}
			document.getElementById("Add").onclick=add
			document.getElementById("SaveAs").onclick=function(){
				if(isElectron&&!isLinux){
					require("electron").remote.dialog.showSaveDialog({
						defaultPath:document.getElementById("TitleInput").value,
						filters:[{name:"RTH Toolbox Files",extensions:["rth"]}]
					},function(filename){
						if(filename){
							require("fs").writeFileSync(filename,JSON.stringify({
								"list":currentList,
								"title":document.getElementById("TitleInput").value
							}))
						}
					})
				}else{
					var filename=document.getElementById("TitleInput").value
					if(filename==""){
						filename=document.title
					}
					if(filename.indexOf(".")==-1){
						filename+=".rth"
					}
					var dl=document.createElement("a")
					dl.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(JSON.stringify({
						"list":currentList,
						"title":document.getElementById("TitleInput").value
					})))
					dl.setAttribute("download",filename)
					if(document.createEvent){
						var event=document.createEvent("MouseEvents")
						event.initEvent("click",true,true)
						dl.dispatchEvent(event)
					}else{
						dl.click()
					}
				}
			}
			document.getElementById("Delete").onclick=function(){
				showConfirm([
					"Do you want to delete the word list?",
					"您想删除此单词表吗？"
				],function(){
					savedWordList.list.splice(currentItem-1,1)
					submit(closeTrue)
				})
			}
			document.getElementById("EnteredWord").onkeydown=function(e){
				if(e.keyCode==13&&this.value!=""){
					if(document.getElementById("EnterDefinitionsSwitch").classList.contains("mui-active")){
						document.getElementById("EnteredDefinition").focus()
					}else{
						next()
					}
				}
			}
			document.getElementById("EnteredDefinition").onkeydown=function(e){
				if(e.keyCode==13&&this.value!=""){
					next()
					if(!showAnswer&&document.getElementById("EnterWordsSwitch").classList.contains("mui-active")){
						document.getElementById("EnteredWord").focus()
					}
				}
			}
			document.getElementById("Option1").onclick=function(){
				optionClicked(0)
			}
			document.getElementById("Option2").onclick=function(){
				optionClicked(1)
			}
			document.getElementById("Option3").onclick=function(){
				optionClicked(2)
			}
			document.getElementById("Option4").onclick=function(){
				optionClicked(3)
			}
			document.getElementById("NextButton").onclick=next
			document.getElementById("Restart").onclick=restartQuiz
			document.getElementById("Speak").onclick=speak
			for(var i=0;i<handle.length;i++){
				handle[i].onclick=function(){
					settingsChanged=true
				}
			}
			document.getElementsByClassName("open-file")[0].onchange=function(e){
				openLWL(e.target.files[0])
			}
			switch(language){
				case "SimplifiedChinese":
				document.title="单词表"
				document.getElementById("LookUpInput").placeholder="输入要查询的单词"
				document.getElementById("LookUpButton").innerText="查询"
				document.getElementById("NewWL").innerText="新单词表"
				document.getElementById("OpenLWL").innerText="打开本地的单词表"
				document.getElementById("SharingSettings").innerText="共享设置"
				document.getElementById("TitleInput").placeholder="标题"
				document.getElementById("Quiz").innerText="测验"
				document.getElementById("SaveAs").innerText="另存为"
				document.getElementById("FlashCard").innerText="学习卡"
				document.getElementById("Save").innerText="保存"
				document.getElementById("Add").innerText="添加"
				document.getElementById("Delete").innerText="删除"
				document.getElementById("WordLabel").innerText="单词"
				document.getElementById("EnteredWord").placeholder="在这里输入"
				document.getElementById("DefinitionLabel").innerText="释义"
				document.getElementById("EnteredDefinition").placeholder="在这里输入"
				document.getElementById("NextButton").innerText="下一题"
				document.getElementById("Restart").innerText="重新开始"
				document.getElementById("Speak").innerText="朗读"
				document.getElementById("MultipleChoice").innerText="选择题"
				document.getElementById("SpeakWords").innerText="朗读单词"
				document.getElementById("SpeakDefinitions").innerText="朗读释义"
				document.getElementById("EnterWords").innerText="输入单词"
				document.getElementById("EnterDefinitions").innerText="输入释义"
				document.getElementById("ShowWords").innerText="显示单词"
				document.getElementById("ShowDefinitions").innerText="显示释义"
				mistakes={
					"list":[],
					"title":"错题"
				}
				break
				default:
				document.title="Word List"
				document.getElementById("LookUpInput").placeholder="Enter the word you want to look up"
				document.getElementById("LookUpButton").innerText="Look Up"
				document.getElementById("NewWL").innerText="New Word List"
				document.getElementById("OpenLWL").innerText="Open Local Word List"
				document.getElementById("SharingSettings").innerText="Sharing Settings"
				document.getElementById("TitleInput").placeholder="Title"
				document.getElementById("Quiz").innerText="Quiz"
				document.getElementById("SaveAs").innerText="Save As"
				document.getElementById("FlashCard").innerText="Flash Card"
				document.getElementById("Save").innerText="Save"
				document.getElementById("Add").innerText="Add"
				document.getElementById("Delete").innerText="Delete"
				document.getElementById("WordLabel").innerText="Word"
				document.getElementById("EnteredWord").placeholder="Enter here"
				document.getElementById("DefinitionLabel").innerText="Definition"
				document.getElementById("EnteredDefinition").placeholder="Enter here"
				document.getElementById("NextButton").innerText="Next"
				document.getElementById("Restart").innerText="Restart"
				document.getElementById("Speak").innerText="Speak"
				document.getElementById("MultipleChoice").innerText="Multiple Choice"
				document.getElementById("SpeakWords").innerText="Speak Words"
				document.getElementById("SpeakDefinitions").innerText="Speak Definitions"
				document.getElementById("EnterWords").innerText="Enter Words"
				document.getElementById("EnterDefinitions").innerText="Enter Definitions"
				document.getElementById("ShowWords").innerText="Show Words"
				document.getElementById("ShowDefinitions").innerText="Show Definitions"
				mistakes={
					"list":[],
					"title":"Mistakes"
				}
				break
			}
			document.getElementsByClassName("mui-title")[0].innerText=document.title
			if(isMobile){
				document.getElementById("OpenLWL").style.display="none"
			}else{
				document.getElementById("LookUpInput").focus()
			}
			if(isEdge||isLinux||isMobile){
				document.getElementById("SaveAs").style.display="none"
			}
			if(!window.speechSynthesis){
				document.getElementById("Speak").style.display="none"
				document.getElementById("SpeakWordsLi").style.display="none"
				document.getElementById("SpeakDefinitionsLi").style.display="none"
			}
			loadSavedWordList()
		</script>
	</body>
</html>
