<!DOCTYPE html>
<html>
	<head>
		<!--Code written by Shangzhen Yang-->
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7">
		<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,viewport-fit=cover">
		<meta name="theme-color" content="#0066cc">
		<meta name="renderer" content="webkit">
		<link href="css/mui.min.css" rel="stylesheet">
		<link href="css/general.css" rel="stylesheet">
	</head>
	<body>
		<header class="mui-bar mui-bar-nav"></header>
		<div class="mui-content">
			<div class="mui-input-row">
				<input type="text" class="mui-input-clear">
			</div>
			<textarea id="Text" rows="10"></textarea>
			<ul class="menu">
				<li id="CreateMessageBox" class="menu"></li>
				<li id="OpenLocalDocument" class="menu"></li>
				<li id="OpenOnlineDocument" class="menu"></li>
				<li id="Share" class="menu"></li>
				<li id="TranslateFullText" class="menu"></li>
				<li id="Speak" class="menu"></li>
				<li id="Delete" class="menu"></li>
				<li id="NewDocument" class="menu"></li>
			</ul>
			<ul id="SavedTextUl" class="menu" style="margin:15px 0px 45px"></ul>
		</div>
		<footer>
			<div id="Save" style="width:50%"></div>
			<div id="RunJSCode" style="width:50%"></div>
		</footer>
		<input id="OpenFileInput" type="file" style="display:none">
		<script src="js/check.js"></script>
		<!--[if !IE]><!-->
		<script src="js/mui.min.js"></script>
		<script src="js/general.js"></script>
		<script type="text/javascript">
			let currentItem,myCodeMirror
			function apply(serialNumber){
				if(serialNumber==0){
					currentItem="Text"
				}else{
					currentItem="Text"+serialNumber
				}
				localStorage.setItem("Text",readText())
				localStorage.setItem("Title",document.getElementsByTagName("input")[0].value)
				localStorage.setItem("TextEditorCurrentItem",currentItem)
				reload()
			}
			function clear(){
				localStorage.removeItem("Text")
				localStorage.removeItem("Title")
				currentItem=="Text"
				localStorage.removeItem("TextEditorCurrentItem")
				reload()
			}
			function count(){
				const wordCount=(readText().match(/[a-z]+|[\u4E00-\uFA29]/ig)||[]).length
				if(wordCount<=0){
					switch(language){
						case "SimplifiedChinese":
							document.getElementsByTagName("input")[0].placeholder="标题"
							break
						default:
							document.getElementsByTagName("input")[0].placeholder="Title"
							break
					}
				}else{
					switch(language){
						case "SimplifiedChinese":
							document.getElementsByTagName("input")[0].placeholder="字数："+wordCount
							break
						default:
							document.getElementsByTagName("input")[0].placeholder="Word Count: "+wordCount
							break
					}
				}
			}
			function enableCodeEditor(){
				if(myCodeMirror==null){
					loadCSS("css/codemirror.css")
					loadJS(["js/codemirror.js","js/javascript.js","js/matchbrackets.js"],function(){
						myCodeMirror=CodeMirror.fromTextArea(document.getElementById("Text"),{
							indentUnit:4,
							lineNumbers:true,
							lineWrapping:true,
							matchBrackets:true,
							mode:"javascript"
						})
						if(appliedTheme=="Dark"){
							loadCSS("css/seti.css")
							myCodeMirror.setOption("theme","seti")
						}
						myCodeMirror.on("change",count)
						textChanged()
					})
				}
			}
			function isEmpty(){
				if(readText()==""){
					showAlert([
						"The text cannot be empty",
						"文本不能为空"
					],[
						"Error",
						"错误"
					])
					return true
				}else{
					return false
				}
			}
			function load(){
				currentItem=localStorage.getItem("TextEditorCurrentItem")
				if(localStorage.getItem("Text")!=null){
					setText(localStorage.getItem("Text"))
					textChanged()
				}
				if(localStorage.getItem("Title")!=null){
					document.getElementsByTagName("input")[0].value=localStorage.getItem("Title")
				}
				let documentsCount=0
				for(let i=9999;i>0;i-=1){
					const savedText=localStorage.getItem("Text"+i)
					if(savedText!=null&&savedText!=""){
						documentsCount+=1
						const newLi=document.createElement("li")
						if(localStorage.getItem("Text"+i+"Title")!=null&&localStorage.getItem("Text"+i+"Title")!=""){
							newLi.innerText=localStorage.getItem("Text"+i+"Title")
						}else{
							newLi.innerText=savedText
						}
						newLi.onclick=function(){
							openText(i)
						}
						if("Text"+i==currentItem){
							newLi.style.color="rgb(0,122,255)"
						}
						document.getElementById("SavedTextUl").appendChild(newLi)
					}
				}
				if(currentItem==null||currentItem=="Text"){
					document.getElementById("Delete").style.display="none"
				}else{
					document.getElementById("Delete").style.display=""
				}
			}
			function newDoc(){
				if(readText()!=""){
					showConfirm([
						"Do you want to close the current document?",
						"您想要关闭当前文档吗？"
					],null,clear)
				}else{
					clear()
				}
			}
			function openLText(file){
				if(file.type.indexOf("text")!=-1){
					const reader=new FileReader()
					reader.onload=function(e){
						document.getElementsByTagName("input")[0].value=file.name
						setText(this.result)
						apply(0)
					}
					reader.readAsText(file)
					const filenameSplit=file.name.split(".")
					readMode(filenameSplit[filenameSplit.length-1])
				}else{
					unsupportedType()
				}
			}
			function openText(serialNumber){
				setText(localStorage.getItem("Text"+serialNumber))
				textChanged()
				document.getElementsByTagName("input")[0].value=localStorage.getItem("Text"+serialNumber+"Title")
				apply(serialNumber)
			}
			function readMode(type){
				if(myCodeMirror!=null){
					if(type=="html"){
						type="htmlmixed"
						loadJS(["http://codemirror.net/mode/xml/xml.js","http://codemirror.net/mode/css/css.js"],function(){setMode(type)})
					}else if(type=="js"){
						type="javascript"
					}else if(type.indexOf("c")!=-1){
						type="clike"
					}
					if(type!="txt"&&type!="rth"&&myCodeMirror.getOption("mode")!=type){
						setMode(type)
					}
				}
			}
			function readText(){
				if(myCodeMirror!=null){
					return myCodeMirror.getValue().replace(/\/\*[^>]+\*\//g,"")
				}else{
					return document.getElementById("Text").value.replace(/\/\*[^>]+\*\//g,"")
				}
			}
			function reload(){
				window.scrollTo(0,0)
				document.getElementsByTagName("input")[0].value=""
				setText("")
				document.getElementById("SavedTextUl").innerHTML=""
				textChanged()
				load()
			}
			function runJSCode(fromShortcut){
				if(!isEmpty()){
					const runTrue=function(){
						const clearData=function(){
							localStorage.clear()
							if(isPlus()){
								plus.cache.clear()
								plus.navigator.removeAllCookie()
							}
							restart()
						}
						const setTheme=function(themeName){
							loadCSS("http://codemirror.net/theme/"+themeName+".css")
							myCodeMirror.setOption("theme",themeName)
						}
						try{
							eval(code)
						}catch(e){
							if(fromShortcut){
								speak()
							}else{
								mui.toast(e.message)
							}
						}
					}
					if(myCodeMirror!=null){
						if(myCodeMirror.getOption("mode")!="javascript"){
							setMode("javascript")
						}
					}
					let code=readText().replace(/coin|runJSCode|runTrue/gi,"").replace(/console.log/g,"mui.toast").replace(/设|let\s/gi,"let ").replace(/答|answer/gi,"const answer=").replace(/answer==/gi,"answer=")
					if(code.indexOf("answer=")!=-1){
						code+=";setText(readText()+'/* ='+answer+' */')"
					}
					if(code.indexOf("language==\"SimplifiedChinese\"")==-1){
						if(/clearData|eval|plus|require/.test(code)){
							showConfirm([
								"This code can harm your device. Do you want to continue?",
								"此代码可能会对您的设备有害。您想要继续吗？"
							],[
								"Warning",
								"警告"
							],runTrue)
						}else{
							runTrue()
						}
					}else{
						runTrue()
					}
				}
			}
			function save(){
				if(isElectron()){
					require("electron").remote.dialog.showSaveDialog({
						defaultPath:document.getElementsByTagName("input")[0].value,
						filters:[{name:"Text Documents",extensions:["txt"]}]
					},function(filename){
						if(filename){
							require("fs").writeFileSync(filename,readText())
						}
					})
				}else if(isMobile()){
					if(currentItem==null||currentItem=="Text"){
						for(let i=1;i<10000;i++){
							if(localStorage.getItem("Text"+i)==null||localStorage.getItem("Text"+i)==""){
								currentItem="Text"+i
								i=10000
							}
						}
						if(currentItem==null){
							return false
						}
					}
					localStorage.setItem(currentItem,readText())
					localStorage.setItem(currentItem+"Title",document.getElementsByTagName("input")[0].value)
					switch(language){
						case "SimplifiedChinese":
							mui.toast("已保存文本")
							break
						default:
							mui.toast("The text has been saved")
							break
					}
					apply(currentItem.replace("Text",""))
				}else{
					showConfirm([
						"Do you want to download this document?",
						"您想要下载此文档吗？"
					],[
						"Save",
						"保存"
					],function(){
						let filename=document.getElementsByTagName("input")[0].value
						if(filename==""){
							switch(language){
								case "SimplifiedChinese":
									filename="文本文档"
									break
								default:
									filename="Text Document"
									break
							}
						}
						const dl=document.createElement("a")
						dl.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(readText()))
						dl.setAttribute("download",filename)
						dl.click()
					})
				}
			}
			function setMode(type){
				loadJS(["http://codemirror.net/mode/"+type+"/"+type+".js"],function(){
					myCodeMirror.setOption("mode",type)
				})
			}
			function setText(text){
				if(myCodeMirror!=null){
					return myCodeMirror.setValue(text)
				}else{
					document.getElementById("Text").value=text
				}
			}
			function speak(){
				if(window.speechSynthesis){
					window.speechSynthesis.speak(new SpeechSynthesisUtterance(readText()))
				}
			}
			function textChanged(){
				if(myCodeMirror!=null){
					setTimeout(function(){
						myCodeMirror.refresh()
					},1)
				}
				count()
			}
			window.onkeydown=function(e){
				if(e.ctrlKey||e.metaKey){
					switch(e.keyCode){
						case 13:
							runJSCode(true)
							break
						case 78:
							newDoc()
							break
						case 79:
							openDialog()
							return false
							break
						case 83:
							save()
							return false
							break
						default:break
					}
				}
			}
			document.getElementsByTagName("textarea")[0].oninput=count
			document.getElementById("CreateMessageBox").onclick=function(){
				if(!isEmpty()){
					if(navigator.onLine){
						openWebPage("http://rthsoftware.tk/web/toolbox/sharedtext.html?alert=1&title="+escape(document.getElementsByTagName("input")[0].value)+"&text="+escape(readText()))
					}else{
						let title=document.getElementsByTagName("input")[0].value
						if(title==""){
							switch(language){
								case "SimplifiedChinese":
									title="无标题"
									break
								default:
									title="Untitled"
									break
							}
						}
						showAlert([
							readText(),
							readText()
						],[
							title,
							title
						])
					}
				}
			}
			document.getElementById("OpenLocalDocument").onclick=openDialog
			document.getElementById("OpenOnlineDocument").onclick=function(){
				showPrompt([
					"Enter the URL",
					"输入网址"
				],[
					"Open",
					"打开"
				],function(url){
					if(url!=null&&url!=""){
						clear()
						if(url.indexOf("?")!=-1&&url.indexOf("text=")!=-1&&url.indexOf("title=")!=-1){
							const title=searchURL("title",url)
							if(title){
								document.getElementsByTagName("input")[0].value=title
							}
							const text=searchURL("text",url)
							if(text){
								setText(text)
							}
							apply(0)
						}else{
							let type=url.split(".")
							type=type[type.length-1]
							if(type.indexOf("c")!=-1){
								if(type.indexOf("/")==-1){
									url+="/"
								}
								url+="index.html"
								type="html"
							}
							if(type=="html"||type=="css"||type=="js"){
								url=addTime(url)
								if(url.indexOf("http")==-1){
									url="http://"+url
								}
								request(url,function(e){
									setText(e)
									apply(0)
								})
								readMode(type)
							}else{
								unsupportedType()
							}
						}
					}
				})
			}
			document.getElementById("Share").onclick=function(){
				if(!isEmpty()){
					openWebPage("http://rthsoftware.tk/web/toolbox/sharedtext.html?title="+escape(document.getElementsByTagName("input")[0].value)+"&text="+escape(readText()))
				}
			}
			document.getElementById("TranslateFullText").onclick=function(){
				translate(readText().replace(/\s/g," "),"auto","auto",function(e){
					setText(readText()+"/* "+e.trans_result[0].dst+" */")
					textChanged()
				})
			}
			document.getElementById("Speak").onclick=speak
			document.getElementById("Delete").onclick=function(){
				showConfirm([
					"Do you want to delete the text document?",
					"您想要删除此文本文档吗？"
				],[
					"Delete",
					"删除"
				],function(){
					localStorage.removeItem(currentItem)
					clear()
				})
			}
			document.getElementById("NewDocument").onclick=newDoc
			document.getElementById("Save").onclick=save
			document.getElementById("RunJSCode").onclick=function(){
				runJSCode(false)
			}
			document.getElementById("OpenFileInput").onchange=function(e){
				openLText(e.target.files[0])
			}
			switch(language){
				case "SimplifiedChinese":
					document.title="文本编辑器"
					document.getElementsByTagName("input")[0].placeholder="标题"
					document.getElementById("Text").placeholder="正文"
					document.getElementById("Save").innerText="保存"
					document.getElementById("RunJSCode").innerText="运行"
					document.getElementById("CreateMessageBox").innerText="创建消息框"
					document.getElementById("OpenLocalDocument").innerText="打开本地文件"
					document.getElementById("OpenOnlineDocument").innerText="打开在线文件"
					document.getElementById("Share").innerText="分享"
					document.getElementById("TranslateFullText").innerText="翻译全文"
					document.getElementById("Speak").innerText="朗读"
					document.getElementById("Delete").innerText="删除"
					document.getElementById("NewDocument").innerText="新建文档"
					break
				default:
					document.title="Text Editor"
					document.getElementsByTagName("input")[0].placeholder="Title"
					document.getElementById("Text").placeholder="Text"
					document.getElementById("Save").innerText="Save"
					document.getElementById("RunJSCode").innerText="Run"
					document.getElementById("CreateMessageBox").innerText="Create Message Box"
					document.getElementById("OpenLocalDocument").innerText="Open Local Document"
					document.getElementById("OpenOnlineDocument").innerText="Open Online Document"
					document.getElementById("Share").innerText="Share"
					document.getElementById("TranslateFullText").innerText="Translate Full Text"
					document.getElementById("Speak").innerText="Speak"
					document.getElementById("Delete").innerText="Delete"
					document.getElementById("NewDocument").innerText="New Document"
					break
			}
			document.getElementsByClassName("mui-title")[0].innerText=document.title
			if(!window.speechSynthesis){
				document.getElementById("Speak").style.display="none"
			}
			if(isMobile()){
				document.getElementById("OpenLocalDocument").style.display="none"
			}
			if(isAndroid()||!isMobile()){
				enableCodeEditor()
			}
			load()
		</script>
		<!--<![endif]-->
	</body>
</html>