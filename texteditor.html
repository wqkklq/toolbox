<!DOCTYPE html>
<html>
	<head>
		<!--Code written by Shangzhen Yang-->
		<meta charset="utf-8"/>
		<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,viewport-fit=cover"/>
		<meta name="theme-color" content="#0066cc"/>
		<title>RTH Toolbox</title>
		<link href="unpackage/res/icons/512x512.png" rel="apple-touch-icon"/>
		<link href="css/mui.min.css" rel="stylesheet"/>
		<link href="css/general.css" rel="stylesheet"/>
		<style>
			#popover{
				height:145px;
				width:200px
			}
		</style>
	</head>
	<body>
		<header class="mui-bar mui-bar-nav title">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left back"></a>
			<h1 class="mui-title"></h1>
		</header>
		<div class="mui-content">
			<ul id="SavedTextUl" class="mui-table-view">
				<li class="mui-table-view-cell">
					<a id="NewTextDoc" href="javascript:Edit()" class="mui-navigate-right"></a>
				</li>
			</ul>
			<div class="mui-input-row">
				<input type="text" class="mui-input-clear" style="display:none"/>
			</div>
			<textarea rows="10" style="display:none" oninput="Count()"></textarea>
			<ul id="OptionUl" class="mui-table-view" style="display:none">
				<li class="mui-table-view-cell">
					<a id="Save" href="javascript:Save()" class="mui-navigate-right"></a>
				</li>
				<li class="mui-table-view-cell">
					<a id="CreateMessageBox" href="#popover" class="mui-navigate-right"></a>
				</li>
				<li class="mui-table-view-cell">
					<a id="TranslateFullText" href="javascript:TranslateFullText()" class="mui-navigate-right"></a>
				</li>
				<li id="CloseLi" class="mui-table-view-cell">
					<a id="Close" href="javascript:Close()" class="mui-navigate-right"></a>
				</li>
				<li id="SpeakLi" class="mui-table-view-cell">
					<a id="Speak" href="javascript:if(window.speechSynthesis){window.speechSynthesis.speak(new SpeechSynthesisUtterance(document.getElementById('TextEditorBox').value))}" class="mui-navigate-right"></a>
				</li>
				<li id="DeleteLi" class="mui-table-view-cell">
					<a id="Delete" href="javascript:Delete()" class="mui-navigate-right"></a>
				</li>
				<li class="mui-table-view-cell">
					<a id="RunJSCode" href="javascript:RunJSCode()" class="mui-navigate-right"></a>
				</li>
			</ul>
			<iframe style="display:none"></iframe>
			<div id="popover" class="mui-popover">
				<div class="mui-scroll-wrapper">
					<div class="mui-scroll">
						<ul class="mui-table-view">
							<li id="Warning" class="mui-table-view-cell"></li>
							<li id="Confirm" class="mui-table-view-cell"></li>
							<li id="Prompt" class="mui-table-view-cell"></li>
						</ul>
					</div>
				</div>
			</div>
		</div>
		<script type="text/javascript">
			var Language=localStorage.getItem("Language"),CurrentItem
			if(Language=="SimplifiedChinese"){
				document.title="文本编辑器"
				document.getElementById("NewTextDoc").innerText="新文本文档"
				document.getElementsByTagName("input")[0].placeholder="标题"
				document.getElementsByTagName("textarea")[0].placeholder="正文"
				document.getElementById("Save").innerText="保存"
				document.getElementById("CreateMessageBox").innerText="创建消息框"
				document.getElementById("Warning").innerText="警告"
				document.getElementById("Confirm").innerText="确认"
				document.getElementById("Prompt").innerText="输入"
				document.getElementById("TranslateFullText").innerText="翻译全文"
				document.getElementById("Close").innerText="关闭文档"
				document.getElementById("Speak").innerText="朗读"
				document.getElementById("Delete").innerText="删除"
				document.getElementById("RunJSCode").innerText="作为 JS 代码运行"
			}else{
				document.title="Text Editor"
				document.getElementById("NewTextDoc").innerText="New Text Document"
				document.getElementsByTagName("input")[0].placeholder="Title"
				document.getElementsByTagName("textarea")[0].placeholder="Text"
				document.getElementById("Save").innerText="Save"
				document.getElementById("CreateMessageBox").innerText="Create Message Box"
				document.getElementById("Warning").innerText="Warning"
				document.getElementById("Confirm").innerText="Confirm"
				document.getElementById("Prompt").innerText="Prompt"
				document.getElementById("TranslateFullText").innerText="Translate Full Text"
				document.getElementById("Close").innerText="Close Document"
				document.getElementById("Speak").innerText="Speak"
				document.getElementById("Delete").innerText="Delete"
				document.getElementById("RunJSCode").innerText="Run as JavaScript Code"
			}
			document.getElementsByClassName("mui-title")[0].innerText=document.title
			if(!window.speechSynthesis){document.getElementById("SpeakLi").style.display="none"}
			var SavedTextList=document.getElementById("SavedTextUl").innerHTML
			Load()
			function Load(){
				CurrentItem=localStorage.getItem("TextEditorCurrentItem")
				if(localStorage.getItem("Text")!=null){
					document.getElementsByTagName("textarea")[0].value=localStorage.getItem("Text")
					Count()
				}
				if(localStorage.getItem("Title")!=null){document.getElementsByTagName("input")[0].value=localStorage.getItem("Title")}
				if(document.getElementsByTagName("textarea")[0].value!=""){Edit()}
				else{
					var DocumentsCount=0
					for (i=9999;i>0;i-=1){
						var SavedText=localStorage.getItem("Text"+i)
						if(SavedText!=null&&SavedText!=""){
							DocumentsCount+=1
							var NewA=document.createElement("a")
							NewA.setAttribute("class","mui-navigate-right")
							if(localStorage.getItem("Text"+i+"Title")!=null&&localStorage.getItem("Text"+i+"Title")!=""){NewA.innerText=localStorage.getItem("Text"+i+"Title")}
							else{NewA.innerText=SavedText}
							NewA.href="javascript:OpenText("+i+")"
							var NewLi=document.createElement("li")
							NewLi.setAttribute("class","mui-table-view-cell")
							NewLi.appendChild(NewA)
							document.getElementById("SavedTextUl").appendChild(NewLi)
						}
					}
					if(DocumentsCount==0){
						Edit()
						document.getElementById("CloseLi").style.display="none"
					}
				}
				if(CurrentItem==null||CurrentItem=="Text"){document.getElementById("DeleteLi").style.display="none"}
				else{document.getElementById("DeleteLi").style.display=""}
			}
			function Edit(){
				document.getElementById("SavedTextUl").style.display="none"
				document.getElementsByTagName("input")[0].style.display=""
				document.getElementsByTagName("textarea")[0].style.display=""
				document.getElementById("OptionUl").style.display=""
			}
			function Count(){
				var Value=document.getElementsByTagName("textarea")[0].value
				var WordCount=(Value.match(/[a-z]+|[\u4E00-\uFA29]/ig)||[]).length
				if(Value.length==0){
					if(Language=="SimplifiedChinese"){document.getElementsByTagName("input")[0].placeholder="标题"}
					else{document.getElementsByTagName("input")[0].placeholder="Title"}
				}else{
					if(Language=="SimplifiedChinese"){document.getElementsByTagName("input")[0].placeholder="字数："+WordCount}
					else{document.getElementsByTagName("input")[0].placeholder="Word Count: "+WordCount}
				}
			}
		</script>
		<script src="js/mui.min.js"></script>
		<script src="js/jquery.min.js"></script>
		<script src="js/md5.min.js"></script>
		<script src="js/general.js"></script>
		<script type="text/javascript">
			Init(true)
			window.onkeydown=function(e){
				if(e.ctrlKey&&e.keyCode==83||e.metaKey&&e.keyCode==83){
					Save()
					return false
				}
			}
			function Reload(){
				document.getElementById("SavedTextUl").style.display=""
				document.getElementById("SavedTextUl").innerHTML=SavedTextList
				document.getElementsByTagName("input")[0].style.display="none"
				document.getElementsByTagName("input")[0].value=""
				document.getElementsByTagName("textarea")[0].style.display="none"
				document.getElementsByTagName("textarea")[0]. value=""
				document.getElementById("OptionUl").style.display="none"
				document.getElementById("CloseLi").style.display=""
				Count()
				Load()
			}
			function Apply(SerialNumber){
				var CurrentItem
				if(SerialNumber==0){CurrentItem="Text"}
				else{CurrentItem="Text"+SerialNumber}
				if(window.localStorage){
					localStorage.setItem("Text",document.getElementsByTagName("textarea")[0].value)
					localStorage.setItem("Title",document.getElementsByTagName("input")[0].value)
					localStorage.setItem("TextEditorCurrentItem",CurrentItem)
					window.scrollTo(0,0)
					Reload()
				}
			}
			function OpenText(SerialNumber){
				document.getElementsByTagName("textarea")[0].value=localStorage.getItem("Text"+SerialNumber)
				Count()
				document.getElementsByTagName("input")[0].value=localStorage.getItem("Text"+SerialNumber+"Title")
				Apply(SerialNumber)
			}
			function Save(){
				if(navigator.userAgent.indexOf("Electron")!=-1){
					require("electron").remote.dialog.showSaveDialog({
						defaultPath:document.getElementsByTagName("input")[0].value,
						filters:[{name:"Text Documents",extensions:["txt"]}]
					},function(filename){
						if(filename){
							require("fs").writeFileSync(filename,document.getElementsByTagName("textarea")[0].value)
							SaveTrue()
						}
					})
				}else{SaveTrue()}
				function SaveTrue(){
					if(window.localStorage){
						if(CurrentItem==null||CurrentItem=="Text"){
							for (i=1;i<10000;i++){
								if(localStorage.getItem("Text"+i)==null||localStorage.getItem("Text"+i)==""){
									CurrentItem="Text"+i
									i=10000
								}
							}
							if(CurrentItem==null){return false}
						}
						localStorage.setItem(CurrentItem,document.getElementsByTagName("textarea")[0].value)
						localStorage.setItem(CurrentItem+"Title",document.getElementsByTagName("input")[0].value)
						if(Language=="SimplifiedChinese"){mui.toast("已保存文本")}
						else{mui.toast("The text has been saved")}
					}
					Apply(CurrentItem.replace("Text",""))
				}
			}
			function Close(){
				if(Language=="SimplifiedChinese"){mui.confirm("您想要关闭文档吗？","关闭",["否","是"],function(e){if(e.index==1){CloseTrue()}})}
				else{mui.confirm("Do you want to close the document?","Close",["No","Yes"],function(e){if(e.index==1){CloseTrue()}})}
			}
			function CloseTrue(){
				document.getElementsByTagName("textarea")[0].value=""
				document.getElementsByTagName("input")[0].value=""
				Count()
				if(window.localStorage){
					localStorage.setItem("Text","")
					localStorage.setItem("Title","")
					localStorage.setItem("TextEditorCurrentItem","Text")
				}
				window.scrollTo(0,0)
				Reload()
			}
			document.getElementById("Warning").onclick=function(){
				mui("#popover").popover("hide")
				var TESplit=document.getElementsByTagName("textarea")[0].value.split("\n")
				if(TESplit.length<2){
					if(Language=="SimplifiedChinese"){
						document.getElementsByTagName("input")[0].value="标题"
						document.getElementsByTagName("textarea")[0].value="内容\n确定"
					}else{
						document.getElementsByTagName("input")[0].value="Title"
						document.getElementsByTagName("textarea")[0].value="Contents\nOK"
					}
					Count()
				}
				TESplit=document.getElementsByTagName("textarea")[0].value.split("\n")
				mui.alert(TESplit[0],document.getElementsByTagName("input")[0].value,TESplit[1])
			}
			document.getElementById("Confirm").onclick=function(){
				mui("#popover").popover("hide")
				var TESplit=document.getElementsByTagName("textarea")[0].value.split("\n")
				if(TESplit.length<3){
					if(Language=="SimplifiedChinese"){
						document.getElementsByTagName("input")[0].value="标题"
						document.getElementsByTagName("textarea")[0].value="内容\n确定\n取消"
					}else{
						document.getElementsByTagName("input")[0].value="Title"
						document.getElementsByTagName("textarea")[0].value="Contents\nOK\nCancel"
					}
					Count()
				}
				TESplit=document.getElementsByTagName("textarea")[0].value.split("\n")
				mui.confirm(TESplit[0],document.getElementsByTagName("input")[0].value,[TESplit[2],TESplit[1]])
			}
			document.getElementById("Prompt").onclick=function(){
				mui("#popover").popover("hide")
				var TESplit=document.getElementsByTagName("textarea")[0].value.split("\n")
				if(TESplit.length<4){
					if(Language=="SimplifiedChinese"){
						document.getElementsByTagName("input")[0].value="标题"
						document.getElementsByTagName("textarea")[0].value="内容\n确定\n取消\n默认文本"
					}else{
						document.getElementsByTagName("input")[0].value="Title"
						document.getElementsByTagName("textarea")[0].value="Contents\nOK\nCancel\nDefault Text"
					}
					Count()
				}
				TESplit=document.getElementsByTagName("textarea")[0].value.split("\n")
				mui.prompt(TESplit[0],TESplit[3],document.getElementsByTagName("input")[0].value,[TESplit[2],TESplit[1]])
			}
			function TranslateFullText(){
				var salt=(new Date).getTime(),query=document.getElementsByTagName("textarea")[0].value.replace(/\n/g," "),to,pattern=new RegExp("[A-Za-z]+")
				if(pattern.test(query)){to="zh"}
				else{to="en"}
				var str1=appid+query+salt+key
				var sign=MD5(str1)
				$.ajax({
					url:"http://api.fanyi.baidu.com/api/trans/vip/translate",
					type:"get",
					dataType:"jsonp",
					data:{
						q:query,
						appid:appid,
						salt:salt,
						from:"auto",
						to:to,
						sign:sign
					},
					success:function(data){
						document.getElementsByTagName("textarea")[0].value+="\n"+data.trans_result[0].dst
						Count()
					}
				})
			}
			function Delete(){
				if(Language=="SimplifiedChinese"){mui.confirm("您想要删除此文本文档吗？","删除",["否","是"],function(e){if(e.index==1){DeleteTrue()}})}
				else{mui.confirm("Do you want to delete the text document?","Delete",["No","Yes"],function(e){if(e.index==1){DeleteTrue()}})}
				function DeleteTrue(){
					if(window.localStorage){
						localStorage.setItem(CurrentItem,"")
						CloseTrue()
					}
				}
			}
			function RunJSCode(){
				var Code=document.getElementsByTagName("textarea")[0].value
				if(Code==""){
					if(Language=="SimplifiedChinese"){mui.alert("请输入代码","文本编辑器")}
					else{mui.alert("Please enter the code","Text Editor","OK")}
				}else{
					document.getElementsByTagName("iframe")[0].contentDocument.open()
					document.getElementsByTagName("iframe")[0].contentDocument.write("<script type='text/javascript'>try{"+Code+"}catch(e){alert(e.message)}<\/script>")
					document.getElementsByTagName("iframe")[0].contentDocument.close()
				}
			}
		</script>
	</body>
</html>