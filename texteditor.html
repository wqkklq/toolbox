<!DOCTYPE html>
<html>
	<head>
		<!--Code written by Shangzhen Yang-->
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,viewport-fit=cover">
		<meta name="theme-color" content="#0066cc">
		<link href="css/mui.min.css" rel="stylesheet">
		<link href="css/general.css" rel="stylesheet">
	</head>
	<body>
		<header class="mui-bar mui-bar-nav title"></header>
		<div class="mui-content">
			<div class="mui-input-row">
				<input type="text" class="mui-input-clear">
			</div>
			<div id="TextDiv">
				<textarea id="Text" rows="10" style="display:none"></textarea>
			</div>
			<ul class="menu">
				<li id="OpenLocalDocument" class="menu"></li>
				<li id="OpenOnlineDocument" class="menu"></li>
				<li id="Delete" class="menu"></li>
				<li id="NewDocument" class="menu"></li>
			</ul>
			<ul class="menu" style="margin-top:15px">
				<li id="CreateMessageBox" class="menu"></li>
				<li id="Translate" class="menu"></li>
				<li id="GetHitokoto" class="menu"></li>
				<li id="Encrypt" class="menu"></li>
				<li id="Decode" class="menu"></li>
				<li id="Speak" class="menu"></li>
			</ul>
			<ul class="menu" style="margin-top:15px">
				<li id="Base64Encode" class="menu"></li>
				<li id="BinaryEncode" class="menu"></li>
				<li id="UnicodeEncode" class="menu"></li>
				<li id="URIComponentEncode" class="menu"></li>
			</ul>
			<ul class="menu" style="margin-top:15px">
				<li id="GenerateQRCode" class="menu"></li>
				<li id="GenerateMD5Value" class="menu"></li>
				<li id="GenerateWebPage" class="menu"></li>
			</ul>
			<ul id="SavedTextUl" class="menu" style="margin:15px 0px 45px"></ul>
		</div>
		<footer>
			<div id="Save" style="width:50%"></div>
			<div id="RunJSCode" style="width:50%"></div>
		</footer>
		<input class="open-file" type="file">
		<script src="cordova.js"></script>
		<script src="js/mui.min.js"></script>
		<script src="js/general.js"></script>
		<script type="text/javascript">
			var currentItem,myCodeMirror
			function addNote(note){
				if(note==null){
					switch(language){
						case "SimplifiedChinese":
							note="正在加载"
							if(!navigator.onLine){
								note+="（没有互联网连接）"
							}
							break
						default:
							note="Loading"
							if(!navigator.onLine){
								note+=" (no Internet connection)"
							}
							break
					}
				}
				setText(readText()+"/* "+note+" */")
			}
			function apply(serialNumber){
				if(serialNumber==0){
					currentItem="Text"
				}else{
					currentItem="Text"+serialNumber
				}
				localStorage.setItem("Text",readText())
				localStorage.setItem("Title",document.getElementsByTagName("input")[0].value)
				localStorage.setItem("TextEditorCurrentItem",currentItem)
				reload()
			}
			function clear(){
				localStorage.removeItem("Text")
				localStorage.removeItem("Title")
				currentItem=="Text"
				localStorage.removeItem("TextEditorCurrentItem")
				reload()
			}
			function clearData(){
				localStorage.clear()
				if(isPlus){
					plus.cache.clear()
					plus.navigator.removeAllCookie()
				}
				restart()
			}
			function count(){
				var wordCount=(readText().match(/[a-z]+|[\u4E00-\uFA29]/ig)||[]).length
				if(wordCount<=0){
					switch(language){
						case "SimplifiedChinese":
							document.getElementsByTagName("input")[0].placeholder="标题"
							break
						default:
							document.getElementsByTagName("input")[0].placeholder="Title"
							break
					}
				}else{
					switch(language){
						case "SimplifiedChinese":
							document.getElementsByTagName("input")[0].placeholder="字数："+wordCount
							break
						default:
							document.getElementsByTagName("input")[0].placeholder="Word Count: "+wordCount
							break
					}
				}
			}
			function decodeUnicode(code){
				if(code.indexOf("\\u")!=-1){
					var escaped=code.replace(/\\u/g,"%u")
					var text=unescape(escaped)
					if(text==escaped){
						return code
					}else{
						return text
					}
				}else{
					return code
				}
			}
			function enableCodeEditor(callback){
				if(myCodeMirror==null){
					loadCSS("css/codemirror.css")
					loadJS(["js/codemirror.js","js/javascript.js","js/matchbrackets.js"],function(){
						myCodeMirror=CodeMirror.fromTextArea(document.getElementById("Text"),{
							indentUnit:4,
							lineNumbers:true,
							lineWrapping:true,
							matchBrackets:true,
							mode:"javascript"
						})
						if(appliedTheme=="Dark"){
							loadCSS("css/seti.css")
							myCodeMirror.setOption("theme","seti")
						}
						myCodeMirror.on("change",count)
						if(!isMobile){
							myCodeMirror.focus()
						}
						document.getElementById("TextDiv").style.marginBottom="15px"
						document.getElementsByClassName("CodeMirror-lines")[0].style.minHeight="300px"
						document.getElementsByClassName("CodeMirror")[0].style.height="100%"
						textChanged()
						if(callback){
							callback()
						}
					})
				}else if(callback){
					callback()
				}
			}
			function encodeUnicode(text){
				var unicode=""
				for(var i=0;i<text.length;i++){
					var charCode=text.charCodeAt(i).toString(16)
					if(charCode.length<4){
						charCode=addZero(charCode,4)
					}
					unicode+="\\u"+charCode
				}
				return unicode
			}
			function isEmpty(){
				if(readText()==""){
					var text
					if(myCodeMirror!=null){
						text=myCodeMirror.getValue()
					}else{
						text=document.getElementById("Text").value
					}
					setText(text.replace(/\/\*|\*\//g,"").trim())
					if(readText()==""){
						showAlert([
							"The text cannot be empty",
							"文本不能为空"
						],[
							"Error",
							"错误"
						])
						return true
					}else{
						return false
					}
				}else{
					return false
				}
			}
			function load(){
				currentItem=localStorage.getItem("TextEditorCurrentItem")
				if(localStorage.getItem("Text")!=null){
					setText(localStorage.getItem("Text"))
				}
				if(localStorage.getItem("Title")!=null){
					document.getElementsByTagName("input")[0].value=localStorage.getItem("Title")
				}
				for(var i=9999;i>0;i-=1){
					var savedText=localStorage.getItem("Text"+i)
					if(savedText!=null&&savedText!=""){
						var newLi=document.createElement("li")
						newLi.setAttribute("class","menu")
						if(localStorage.getItem("Text"+i+"Title")!=null&&localStorage.getItem("Text"+i+"Title")!=""){
							newLi.innerText=localStorage.getItem("Text"+i+"Title")
						}else{
							newLi.innerText=savedText
						}
						newLi.setAttribute("number",i)
						newLi.onclick=function(){
							openText(this.getAttribute("number"))
						}
						if("Text"+i==currentItem){
							newLi.style.color="rgb(0,122,255)"
						}
						document.getElementById("SavedTextUl").appendChild(newLi)
					}
				}
				if(document.getElementById("SavedTextUl").getElementsByTagName("li").length>0){
					document.getElementById("SavedTextUl").style.marginBottom="60px"
				}
				if(currentItem==null||currentItem=="Text"){
					document.getElementById("Delete").style.display="none"
				}else{
					document.getElementById("Delete").style.display=""
				}
			}
			function newDoc(){
				if(readText()!=""){
					showConfirm([
						"Do you want to close the current document?",
						"您想要关闭当前文档吗？"
					],null,clear)
				}else{
					clear()
				}
			}
			function only(regExp,text){
				var array=text.split(""),
				passed=""
				for(var i=0;i<array.length;i++){
					if(regExp.test(array[i])){
						passed+=array[i]
					}
				}
				if(passed==text){
					return true
				}else{
					return false
				}
			}
			function openLText(file){
				if(file.type.indexOf("text")!=-1){
					var reader=new FileReader()
					reader.onload=function(e){
						document.getElementsByTagName("input")[0].value=file.name
						setText(this.result)
						apply(0)
					}
					reader.readAsText(file)
					var filenameSplit=file.name.split(".")
					readMode(filenameSplit[filenameSplit.length-1])
				}else{
					unsupportedType()
				}
			}
			function openText(serialNumber){
				setText(localStorage.getItem("Text"+serialNumber))
				document.getElementsByTagName("input")[0].value=localStorage.getItem("Text"+serialNumber+"Title")
				apply(serialNumber)
			}
			function readMode(type){
				if(myCodeMirror!=null){
					if(type=="html"){
						type="htmlmixed"
						loadJS(["http://codemirror.net/mode/xml/xml.js","http://codemirror.net/mode/css/css.js"],function(){
							setMode(type)
						})
					}else if(type=="js"){
						type="javascript"
					}else if(type.indexOf("c")!=-1&&type.indexOf("css")==-1){
						type="clike"
					}else if(type=="md"){
						type="markdown"
					}
					if(type!="txt"&&type!="rth"&&myCodeMirror.getOption("mode")!=type){
						setMode(type)
					}
				}
			}
			function readText(){
				if(myCodeMirror!=null){
					return myCodeMirror.getValue().replace(/\/\*[^>]+\*\//g,"")
				}else{
					return document.getElementById("Text").value.replace(/\/\*[^>]+\*\//g,"")
				}
			}
			function reload(){
				document.getElementsByTagName("input")[0].value=""
				setText("")
				document.getElementById("SavedTextUl").style.marginBottom="45px"
				document.getElementById("SavedTextUl").innerHTML=""
				load()
			}
			function runJSCode(fromShortcut){
				if(!isEmpty()){
					var code=readText().replace(/coin|runJSCode|runTrue/gi,"").replace(/console.log/g,"mui.toast")
					var runTrue=function(){
						try{
							var result=calc(code)
							if(result!=undefined){
								addNote(result)
							}
						}catch(e){
							if(fromShortcut){
								speak()
							}else{
								mui.toast(e.message)
							}
						}
					}
					if(myCodeMirror!=null){
						if(myCodeMirror.getOption("mode")!="javascript"){
							setMode("javascript")
						}
					}
					if(code.indexOf("switch(language)")==-1){
						if(/clearData|eval|plus|require/.test(code)){
							showConfirm([
								"This code can harm your device. Do you want to continue?",
								"此代码可能会对您的设备有害。您想要继续吗？"
							],[
								"Warning",
								"警告"
							],runTrue)
						}else{
							runTrue()
						}
					}else{
						runTrue()
					}
				}
			}
			function save(){
				if(isElectron&&!isLinux){
					require("electron").remote.dialog.showSaveDialog({
						defaultPath:document.getElementsByTagName("input")[0].value,
						filters:[{name:"Text Documents",extensions:["txt"]}]
					},function(filename){
						if(filename){
							require("fs").writeFileSync(filename,readText())
						}
					})
				}else if(isEdge||isLinux||isMobile){
					if(currentItem==null||currentItem=="Text"){
						for(var i=1;i<10000;i++){
							if(localStorage.getItem("Text"+i)==null||localStorage.getItem("Text"+i)==""){
								currentItem="Text"+i
								i=10000
							}
						}
						if(currentItem==null){
							return false
						}
					}
					localStorage.setItem(currentItem,readText())
					localStorage.setItem(currentItem+"Title",document.getElementsByTagName("input")[0].value)
					switch(language){
						case "SimplifiedChinese":
							mui.toast("已保存文本")
							break
						default:
							mui.toast("The text has been saved")
							break
					}
					apply(currentItem.replace("Text",""))
				}else{
					showConfirm([
						"Do you want to download this document?",
						"您想要下载此文档吗？"
					],[
						"Save",
						"保存"
					],function(){
						var filename=document.getElementsByTagName("input")[0].value
						if(filename==""){
							switch(language){
								case "SimplifiedChinese":
									filename="文本文档"
									break
								default:
									filename="Text Document"
									break
							}
						}
						if(filename.indexOf(".")==-1){
							filename+=".txt"
						}
						var dl=document.createElement("a")
						dl.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(readText()))
						dl.setAttribute("download",filename)
						if(document.createEvent){
							var event=document.createEvent("MouseEvents")
							event.initEvent("click",true,true)
							dl.dispatchEvent(event)
						}else{
							dl.click()
						}
					})
				}
			}
			function setMode(type){
				loadJS(["http://codemirror.net/mode/"+type+"/"+type+".js"],function(){
					myCodeMirror.setOption("mode",type)
				})
			}
			function setText(text){
				if(myCodeMirror!=null){
					myCodeMirror.setValue(text)
				}else{
					document.getElementById("Text").value=text
				}
				textChanged()
				window.scrollTo(0,0)
			}
			function setTheme(themeName){
				loadCSS("http://codemirror.net/theme/"+themeName+".css")
				myCodeMirror.setOption("theme",themeName)
			}
			function speak(){
				if(!isEmpty()&&window.speechSynthesis){
					window.speechSynthesis.speak(new SpeechSynthesisUtterance(readText()))
				}
			}
			function textChanged(){
				if(myCodeMirror!=null){
					setTimeout(function(){
						myCodeMirror.refresh()
					},1)
				}
				count()
			}
			window.onkeydown=function(e){
				if(e.ctrlKey||e.metaKey){
					switch(e.keyCode){
						case 13:
							runJSCode(true)
							return false
							break
						case 78:
							newDoc()
							return false
							break
						case 79:
							openDialog()
							return false
							break
						case 83:
							save()
							return false
							break
						default:break
					}
				}
			}
			document.getElementsByTagName("textarea")[0].oninput=count
			document.getElementById("Save").onclick=save
			document.getElementById("RunJSCode").onclick=function(){
				runJSCode(false)
			}
			document.getElementById("OpenLocalDocument").onclick=openDialog
			document.getElementById("OpenOnlineDocument").onclick=function(){
				showPrompt([
					"Enter the URL",
					"输入网址"
				],[
					"Open",
					"打开"
				],function(url){
					if(url!=null&&url!=""){
						clear()
						if(url.indexOf("?")!=-1&&url.indexOf("text=")!=-1&&url.indexOf("title=")!=-1){
							var title=searchURL("title",url)
							if(title){
								document.getElementsByTagName("input")[0].value=title
							}
							var text=searchURL("text",url)
							if(text){
								setText(text)
							}
							apply(0)
						}else{
							var type=url.split(".")
							type=type[type.length-1]
							if(type.indexOf("c")!=-1&&type.indexOf("css")==-1){
								if(type.indexOf("/")==-1){
									url+="/"
								}
								url+="index.html"
								type="html"
							}
							var openTrue=function(){
								url=addTime(url)
								if(url.indexOf("http")==-1){
									url="http://"+url
								}
								request(url,function(e){
									setText(e)
									apply(0)
								})
								readMode(type)
							}
							if(type=="txt"){
								openTrue()
							}else if(/html|css|js/.test(type)){
								enableCodeEditor(openTrue)
							}else{
								unsupportedType()
							}
						}
					}
				})
			}
			document.getElementById("Delete").onclick=function(){
				showConfirm([
					"Do you want to delete the text document?",
					"您想要删除此文本文档吗？"
				],[
					"Delete",
					"删除"
				],function(){
					localStorage.removeItem(currentItem)
					clear()
				})
			}
			document.getElementById("NewDocument").onclick=newDoc
			document.getElementById("CreateMessageBox").onclick=function(){
				if(!isEmpty()){
					if(navigator.onLine){
						openWebPage("http://rthsoftware.tk/sharedtext?alert=1&title="+escape(document.getElementsByTagName("input")[0].value)+"&text="+escape(readText()))
					}else{
						var title=document.getElementsByTagName("input")[0].value
						if(title==""){
							switch(language){
								case "SimplifiedChinese":
									title="无标题"
									break
								default:
									title="Untitled"
									break
							}
						}
						showAlert([
							readText(),
							readText()
						],[
							title,
							title
						])
					}
				}
			}
			document.getElementById("Translate").onclick=function(){
				if(!isEmpty()){
					addNote()
					translate(readText().replace(/\s/g," "),"auto","auto",function(e){
						addNote(e.trans_result[0].dst)
					})
				}
			}
			document.getElementById("GetHitokoto").onclick=function(){
				addNote()
				request("https://sslapi.hitokoto.cn/",function(e){
					var json=JSON.parse(e)
					addNote("「"+json.hitokoto+"」——"+json.from)
				})
			}
			document.getElementById("Encrypt").onclick=function(){
				if(!isEmpty()){
					showPrompt([
						"Please set the password",
						"请设置密码"
					],[
						"Encrypt",
						"加密"
					],function(e){
						addNote()
						loadJS(["js/md5.min.js"],function(){
							var encrypted="",
							text=readText().replace(/丨/g,"｜")+"丨"+MD5(e)
							for(var i=0;i<text.length;i++){
								encrypted+=(text.charCodeAt(i)*8).toString(8)+"9"
							}
							setText(btoa(encrypted))
						})
					})
				}
			}
			document.getElementById("Decode").onclick=function(){
				if(!isEmpty()){
					var encoded=readText()
					var decoded=encoded
					try{
						if(decoded.indexOf(" ")==-1){
							if(only(/0|1/,decoded)){
								decoded=String.fromCharCode(parseInt(decoded,2))
							}else if(decoded.indexOf("%u")!=-1){
								decoded=unescape(decoded)
							}else if(decoded.indexOf("%")!=-1){
								decoded=decodeURIComponent(decoded)
							}else if(decoded.indexOf("\\u")!=-1){
								decoded=decodeUnicode(decoded)
							}else{
								decoded=decodeUnicode(atob(decoded))
								if(only(isNumber,decoded)){
									var encrypted=decoded.split("9"),
									str=""
									for(var i=0;i<encrypted.length;i++){
										str+=String.fromCharCode(parseInt(encrypted[i],8)/8)
									}
									if(str.indexOf("丨")!=-1){
										showPrompt([
											"Please enter the password",
											"请输入密码"
										],[
											"Decrypt",
											"解密"
										],function(e){
											addNote()
											loadJS(["js/md5.min.js"],function(){
												if(MD5(e)==str.substr(str.indexOf("丨")+1,32)){
													setText(str.substr(0,str.indexOf("丨")))
												}else{
													setText(encoded)
													showAlert([
														"Incorrect password",
														"密码错误"
													],[
														"Error",
														"错误"
													])
												}
											})
										})
										return false
									}
								}
							}
						}else if(only(/0|1|\s/,decoded)){
							var binaries=decoded.split(" "),
							str=""
							for(var i=0;i<binaries.length;i++){
								str+=String.fromCharCode(parseInt(binaries[i],2))
							}
							decoded=str
						}
					}catch(e){
						showAlert([
							e.message,
							e.message
						],[
							"Error",
							"错误"
						])
					}
					setText(decoded)
				}
			}
			document.getElementById("Speak").onclick=speak
			document.getElementById("Base64Encode").onclick=function(){
				if(!isEmpty()){
					try{
						setText(btoa(readText()))
					}catch(e){
						setText(btoa(encodeUnicode(readText())))
					}
				}
			}
			document.getElementById("BinaryEncode").onclick=function(){
				if(!isEmpty()){
					var binary="",
					text=readText()
					for(var i=0;i<text.length;i++){
						binary+=text.charCodeAt(i).toString(2)+" "
					}
					setText(binary.trim())
				}
			}
			document.getElementById("UnicodeEncode").onclick=function(){
				if(!isEmpty()){
					setText(encodeUnicode(readText()))
				}
			}
			document.getElementById("URIComponentEncode").onclick=function(){
				if(!isEmpty()){
					setText(encodeURIComponent(readText()))
				}
			}
			document.getElementById("GenerateQRCode").onclick=function(){
				if(!isEmpty()){
					showImage("http://qr.topscan.com/api.php?text="+readText())
				}
			}
			document.getElementById("GenerateMD5Value").onclick=function(){
				if(!isEmpty()){
					addNote()
					loadJS(["js/md5.min.js"],function(){
						addNote(MD5(readText()))
					})
				}
			}
			document.getElementById("GenerateWebPage").onclick=function(){
				if(!isEmpty()){
					openWebPage("http://rthsoftware.tk/sharedtext?title="+escape(document.getElementsByTagName("input")[0].value)+"&text="+escape(readText()))
				}
			}
			document.getElementsByClassName("open-file")[0].onchange=function(e){
				openLText(e.target.files[0])
			}
			switch(language){
				case "SimplifiedChinese":
					document.title="文本编辑器"
					document.getElementsByTagName("input")[0].placeholder="标题"
					document.getElementById("Text").placeholder="正文"
					document.getElementById("Save").innerText="保存"
					document.getElementById("RunJSCode").innerText="运行"
					document.getElementById("OpenLocalDocument").innerText="打开本地文件"
					document.getElementById("OpenOnlineDocument").innerText="打开在线文件"
					document.getElementById("Delete").innerText="删除"
					document.getElementById("NewDocument").innerText="新建文档"
					document.getElementById("CreateMessageBox").innerText="创建消息框"
					document.getElementById("Translate").innerText="翻译"
					document.getElementById("GetHitokoto").innerText="获取一言"
					document.getElementById("Encrypt").innerText="加密"
					document.getElementById("Decode").innerText="解码"
					document.getElementById("Speak").innerText="朗读"
					document.getElementById("Base64Encode").innerText="Base64 编码"
					document.getElementById("BinaryEncode").innerText="二进制编码"
					document.getElementById("UnicodeEncode").innerText="Unicode 编码"
					document.getElementById("URIComponentEncode").innerText="URI Component 编码"
					document.getElementById("GenerateQRCode").innerText="生成二维码"
					document.getElementById("GenerateMD5Value").innerText="生成 MD5 值"
					document.getElementById("GenerateWebPage").innerText="生成网页"
					break
				default:
					document.title="Text Editor"
					document.getElementsByTagName("input")[0].placeholder="Title"
					document.getElementById("Text").placeholder="Text"
					document.getElementById("Save").innerText="Save"
					document.getElementById("RunJSCode").innerText="Run"
					document.getElementById("OpenLocalDocument").innerText="Open Local Document"
					document.getElementById("OpenOnlineDocument").innerText="Open Online Document"
					document.getElementById("Delete").innerText="Delete"
					document.getElementById("NewDocument").innerText="New Document"
					document.getElementById("CreateMessageBox").innerText="Create Message Box"
					document.getElementById("Translate").innerText="Translate"
					document.getElementById("GetHitokoto").innerText="Get Hitokoto"
					document.getElementById("Encrypt").innerText="Encrypt"
					document.getElementById("Decode").innerText="Decode"
					document.getElementById("Speak").innerText="Speak"
					document.getElementById("Base64Encode").innerText="Base64 Encode"
					document.getElementById("BinaryEncode").innerText="Binary Encode"
					document.getElementById("UnicodeEncode").innerText="Unicode Encode"
					document.getElementById("URIComponentEncode").innerText="URI Component Encode"
					document.getElementById("GenerateQRCode").innerText="Generate QR Code"
					document.getElementById("GenerateMD5Value").innerText="Generate MD5 Value"
					document.getElementById("GenerateWebPage").innerText="Generate Web Page"
					break
			}
			document.getElementsByClassName("mui-title")[0].innerText=document.title
			if(!window.speechSynthesis){
				document.getElementById("Speak").style.display="none"
			}
			if(isMobile){
				document.getElementById("Text").style.display=""
				document.getElementById("OpenLocalDocument").style.display="none"
			}else{
				enableCodeEditor()
			}
			if(isOnline){
				document.getElementById("OpenOnlineDocument").style.display="none"
			}
			load()
		</script>
	</body>
</html>
