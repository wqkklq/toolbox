<!DOCTYPE html>
<html>
	<head>
		<!--Code written by Shangzhen Yang-->
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7">
		<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,viewport-fit=cover">
		<meta name="theme-color" content="#0066cc">
		<meta name="renderer" content="webkit">
		<title>RTH Toolbox</title>
		<link href="unpackage/res/icons/512x512.png" rel="apple-touch-icon">
		<link href="css/mui.min.css" rel="stylesheet">
		<link href="css/general.css" rel="stylesheet">
		<link href="css/codemirror.css" rel="stylesheet">
	</head>
	<body>
		<header class="mui-bar mui-bar-nav title">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left back"></a>
			<h1 class="mui-title"></h1>
		</header>
		<div class="win" style="display:none">
			<div style="right:80px" onclick="require('electron').remote.getCurrentWindow().minimize()">-</div>
			<div style="right:40px" onclick="maximize()">+</div>
			<div style="right:0px" onclick="window.close()">×</div>
		</div>
		<div class="mui-content">
			<div class="mui-input-row">
				<input type="text" class="mui-input-clear">
			</div>
			<textarea id="Text" rows="10" oninput="count()"></textarea>
			<ul id="OptionUl" class="mui-table-view">
				<li class="mui-table-view-cell">
					<a id="Save" href="javascript:save()" class="mui-navigate-right"></a>
				</li>
				<li class="mui-table-view-cell">
					<a id="CreateMessageBox" href="javascript:createMessageBox()" class="mui-navigate-right"></a>
				</li>
				<li class="mui-table-view-cell">
					<a id="Open" href="javascript:openDialog()" class="mui-navigate-right"></a>
				</li>
				<li class="mui-table-view-cell">
					<a id="Share" href="javascript:if(!isEmpty()){openWebPage('http://rthsoftware.tk/web/toolbox/sharedtext.html?title='+escape(document.getElementsByTagName('input')[0].value)+'&text='+escape(readText()))}" class="mui-navigate-right"></a>
				</li>
				<li class="mui-table-view-cell">
					<a id="TranslateFullText" href="javascript:translateFullText()" class="mui-navigate-right"></a>
				</li>
				<li id="SpeakLi" class="mui-table-view-cell">
					<a id="Speak" href="javascript:if(window.speechSynthesis){window.speechSynthesis.speak(new SpeechSynthesisUtterance(readText()))}" class="mui-navigate-right"></a>
				</li>
				<li class="mui-table-view-cell">
					<a id="Clear" href="javascript:clear()" class="mui-navigate-right"></a>
				</li>
				<li id="DeleteLi" class="mui-table-view-cell">
					<a id="Delete" href="javascript:Delete()" class="mui-navigate-right"></a>
				</li>
				<li class="mui-table-view-cell">
					<a id="RunJSCode" href="javascript:runJSCode()" class="mui-navigate-right"></a>
				</li>
			</ul>
			<ul id="SavedTextUl" class="mui-table-view" style="margin-top:15px;display:none"></ul>
		</div>
		<input id="OpenFileInput" type="file" accept=".txt,.js" style="display:none" onchange="openLText(event.target.files[0])">
		<!--[if IE]>
			<script type="text/javascript">
				window.location.href="http://t.rths.tk/web/toolbox/download.html?time="+(new Date).getTime()
			</script>
		<![endif]-->
		<!--[if !IE]><!-->
		<script src="js/mui.min.js"></script>
		<script src="js/general.js"></script>
		<script type="text/javascript">
			var currentItem
			if(language=="SimplifiedChinese"){
				document.title="文本编辑器"
				document.getElementsByTagName("input")[0].placeholder="标题"
				document.getElementById("Text").placeholder="正文"
				document.getElementById("Save").innerText="保存"
				document.getElementById("CreateMessageBox").innerText="创建消息框"
				document.getElementById("Open").innerText="打开"
				document.getElementById("Share").innerText="分享"
				document.getElementById("TranslateFullText").innerText="翻译全文"
				document.getElementById("Speak").innerText="朗读"
				document.getElementById("Clear").innerText="清空"
				document.getElementById("Delete").innerText="删除"
				document.getElementById("RunJSCode").innerText="作为 JS 代码运行"
			}else{
				document.title="Text Editor"
				document.getElementsByTagName("input")[0].placeholder="Title"
				document.getElementById("Text").placeholder="Text"
				document.getElementById("Save").innerText="Save"
				document.getElementById("CreateMessageBox").innerText="Create Message Box"
				document.getElementById("Open").innerText="Open"
				document.getElementById("Share").innerText="Share"
				document.getElementById("TranslateFullText").innerText="Translate Full Text"
				document.getElementById("Speak").innerText="Speak"
				document.getElementById("Clear").innerText="Clear"
				document.getElementById("Delete").innerText="Delete"
				document.getElementById("RunJSCode").innerText="Run as JavaScript Code"
			}
			document.getElementsByClassName("mui-title")[0].innerText=document.title
			if(!window.speechSynthesis){document.getElementById("SpeakLi").style.display="none"}
			var myCodeMirror
			if(!isMobile()){
				loadJS(["js/codemirror.js","js/javascript.js","js/matchbrackets.js"],function(){
					myCodeMirror=CodeMirror.fromTextArea(document.getElementById("Text"),{
						indentUnit:4,
						lineNumbers:true,
						matchBrackets:true,
						mode:"javascript",
						lineWrapping:true
					})
					myCodeMirror.on("change",count)
					textChanged()
				})
			}
			load()
			function readText(){
				if(myCodeMirror!=null){return myCodeMirror.getValue().replace(/\/\*[^>]+\*\//g,"")}
				else{return document.getElementById("Text").value.replace(/\/\*[^>]+\*\//g,"")}
			}
			function setText(text){
				if(myCodeMirror!=null){return myCodeMirror.setValue(text)}
				else{document.getElementById("Text").value=text}
			}
			function load(){
				currentItem=localStorage.getItem("TextEditorCurrentItem")
				if(localStorage.getItem("Text")!=null){
					setText(localStorage.getItem("Text"))
					textChanged()
				}
				if(localStorage.getItem("Title")!=null){document.getElementsByTagName("input")[0].value=localStorage.getItem("Title")}
				var documentsCount=0
				for(var i=9999;i>0;i-=1){
					var savedText=localStorage.getItem("Text"+i)
					if(savedText!=null&&savedText!=""){
						documentsCount+=1
						var newA=document.createElement("a")
						if(localStorage.getItem("Text"+i+"Title")!=null&&localStorage.getItem("Text"+i+"Title")!=""){newA.innerText=localStorage.getItem("Text"+i+"Title")}
						else{newA.innerText=savedText}
						newA.href="javascript:openText("+i+")"
						var newLi=document.createElement("li")
						newLi.setAttribute("class","mui-table-view-cell")
						if("Text"+i==currentItem){newLi.style.backgroundColor="whitesmoke"}
						newLi.appendChild(newA)
						document.getElementById("SavedTextUl").appendChild(newLi)
					}
				}
				if(documentsCount>0){document.getElementById("SavedTextUl").style.display=""}
				if(currentItem==null||currentItem=="Text"){document.getElementById("DeleteLi").style.display="none"}
				else{document.getElementById("DeleteLi").style.display=""}
			}
			function textChanged(){
				if(myCodeMirror!=null){setTimeout(function(){myCodeMirror.refresh()},1)}
				count()
			}
			function count(){
				var wordCount=(readText().match(/[a-z]+|[\u4E00-\uFA29]/ig)||[]).length
				if(wordCount<=0){
					if(language=="SimplifiedChinese"){document.getElementsByTagName("input")[0].placeholder="标题"}
					else{document.getElementsByTagName("input")[0].placeholder="Title"}
				}else{
					if(language=="SimplifiedChinese"){document.getElementsByTagName("input")[0].placeholder="字数："+wordCount}
					else{document.getElementsByTagName("input")[0].placeholder="Word Count: "+wordCount}
				}
			}
			window.onkeydown=function(e){
				if(e.ctrlKey||e.metaKey){
					if(e.keyCode==83){
						save()
						return false
					}
				}
			}
			function reload(){
				window.scrollTo(0,0)
				document.getElementsByTagName("input")[0].value=""
				setText("")
				document.getElementById("SavedTextUl").style.display="none"
				document.getElementById("SavedTextUl").innerHTML=""
				textChanged()
				load()
			}
			function apply(serialNumber){
				if(serialNumber==0){currentItem="Text"}
				else{currentItem="Text"+serialNumber}
				localStorage.setItem("Text",readText())
				localStorage.setItem("Title",document.getElementsByTagName("input")[0].value)
				localStorage.setItem("TextEditorCurrentItem",currentItem)
				reload()
			}
			function openText(serialNumber){
				setText(localStorage.getItem("Text"+serialNumber))
				textChanged()
				document.getElementsByTagName("input")[0].value=localStorage.getItem("Text"+serialNumber+"Title")
				apply(serialNumber)
			}
			function openLText(file){
				if(file.name.split(".")[1]=="txt"||file.name.split(".")[1]=="js"){
					var reader=new FileReader()
					reader.onload=function(e){
						document.getElementsByTagName("input")[0].value=file.name.split(".")[0]
						setText(this.result)
						apply(0)
					}
					reader.readAsText(file)
				}else{
					if(language=="SimplifiedChinese"){mui.alert("无法打开此类文件","文本编辑器")}
					else{mui.alert("Unable to open this type of file","Text Editor","OK")}
				}
			}
			function save(){
				if(isElectron()){
					require("electron").remote.dialog.showSaveDialog({
						defaultPath:document.getElementsByTagName("input")[0].value,
						filters:[{name:"Text Documents",extensions:["txt"]}]
					},function(filename){if(filename){require("fs").writeFileSync(filename,readText())}})
				}else if(isMobile()||isEdge()){
					if(currentItem==null||currentItem=="Text"){
						for(var i=1;i<10000;i++){
							if(localStorage.getItem("Text"+i)==null||localStorage.getItem("Text"+i)==""){
								currentItem="Text"+i
								i=10000
							}
						}
						if(currentItem==null){return false}
					}
					localStorage.setItem(currentItem,readText())
					localStorage.setItem(currentItem+"Title",document.getElementsByTagName("input")[0].value)
					if(language=="SimplifiedChinese"){mui.toast("已保存文本")}
					else{mui.toast("The text has been saved")}
					apply(currentItem.replace("Text",""))
				}else{
					var filename=document.getElementsByTagName("input")[0].value
					if(filename==""){
						if(language=="SimplifiedChinese"){filename="文本文档"}
						else{filename="Text Document"}
					}
					var dl=document.createElement("a")
					dl.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(readText()))
					dl.setAttribute("download",filename)
					if(document.createEvent){
						var event=document.createEvent("MouseEvents")
						event.initEvent("click",true,true)
						dl.dispatchEvent(event)
					}else{dl.click()}
				}
			}
			function isEmpty(){
				if(readText()==""){
					if(language=="SimplifiedChinese"){mui.alert("文本不能为空","错误")}
					else{mui.alert("The text cannot be empty","Error","OK")}
					return true
				}else{return false}
			}
			function createMessageBox(){
				if(!isEmpty()){
					if(navigator.onLine){
						openWebPage("http://rthsoftware.tk/web/toolbox/sharedtext.html?alert=1&title="+escape(document.getElementsByTagName("input")[0].value)+"&text="+escape(readText()))
					}else{
						var title=document.getElementsByTagName("input")[0].value
						if(title==""){
							if(language=="SimplifiedChinese"){title="无标题"}
							else{title="Untitled"}
						}
						if(language=="SimplifiedChinese"){mui.alert(readText(),title)}
						else{mui.alert(readText(),title,"OK")}
					}
				}
			}
			function translateFullText(){
				translate(readText().replace(/\s/g," "),"auto","auto",function(e){
					setText(readText()+"/* "+e.trans_result[0].dst+" */")
					textChanged()
				})
			}
			function clear(){
				if(language=="SimplifiedChinese"){mui.confirm("您想要清空文本吗？","清空",["否","是"],function(e){if(e.index==1){clearTrue()}})}
				else{mui.confirm("Do you want to clear the text?","Clear",["No","Yes"],function(e){if(e.index==1){clearTrue()}})}
			}
			function clearTrue(){
				localStorage.removeItem("Text")
				localStorage.removeItem("Title")
				currentItem=="Text"
				localStorage.removeItem("TextEditorCurrentItem")
				reload()
			}
			function Delete(){
				var deleteTrue=function(){
					localStorage.removeItem(currentItem)
					clearTrue()
				}
				if(language=="SimplifiedChinese"){mui.confirm("您想要删除此文本文档吗？","删除",["否","是"],function(e){if(e.index==1){deleteTrue()}})}
				else{mui.confirm("Do you want to delete the text document?","Delete",["No","Yes"],function(e){if(e.index==1){deleteTrue()}})}
			}
			function runJSCode(){
				if(!isEmpty()){
					var runTrue=function(){
						try{eval(code)}
						catch(e){
							if(language=="SimplifiedChinese"){mui.alert(e.message,"错误")}
							else{mui.alert(e.message,"Error","OK")}
						}
					}
					var code=readText().replace(/coin|runJSCode|runTrue/gi,"").replace(/console.log/g,"mui.toast")
					if(code.indexOf("init()")==-1&&code.indexOf("initElectron()")==-1&&code.indexOf("RTH Toolbox")==-1){
						if(code.indexOf("eval")!=-1||isPlus()&&code.indexOf("plus")!=-1||isElectron()&&code.indexOf("require")!=-1){
							if(language=="SimplifiedChinese"){mui.confirm("此代码可能会对您的设备有害","警告",["取消","继续"],function(e){if(e.index==1){runTrue()}})}
							else{mui.confirm("This code can harm your device","Warning",["Cancel","Continue"],function(e){if(e.index==1){runTrue()}})}
						}else{runTrue()}
					}else{runTrue()}
				}
			}
		</script>
		<!--<![endif]-->
	</body>
</html>